<!--
Copyright 2016 Google Inc. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at
  http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">

<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/neon-animation/animations/scale-up-animation.html">
<link rel="import" href="../bower_components/neon-animation/animations/fade-out-animation.html">

<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">

<link rel="import" href="shared-app-styles.html">
<link rel="import" href="PageBehavior.html">

<link rel="import" href="io-schedule.html">
<link rel="import" href="io-agenda.html">

<dom-module id="io-schedule-page">
<link rel="import" type="css" href="io-schedule-page.css">
<template>
<style include="shared-app-styles">
  paper-dropdown-menu {
    --paper-input-container-color: inherit;
    --paper-dropdown-menu-icon: {
      color: inherit;
    };
    --paper-input-container-underline-focus: {
      display: none;
    };
  }
</style>

<div class="masthead-container" layout vertical end-justified>
  <div class="masthead-meta">
    <h1 class="focus-target" tabindex="-1">Schedule</h1>
  </div>
</div>

<!-- backdrop shouldn't be applied on ios - github.com/Polymer/paper-dialog/issues/16 -->
<paper-dialog id="sessionDetails" class="session__detail scrollable"
              entry-animation="scale-up-animation"
              exit-animation="fade-out-animation"
              with-backdrop="[[!app.isIOS]]"
              on-iron-overlay-closed="onSessionDetailsClose"
              on-iron-overlay-opened="onSessionDetailsOpen">
  <div class="scrollable">
    <paper-icon-button icon="io:arrow-back" dialog-dismiss
                       aria-label="Close session"></paper-icon-button>
    <div class="card__photo" relative>

      <template is="dom-if" if="[[sessionHasVideo(_startScheduleVideo, selectedSession.isLivestream, selectedSession.youtubeUrl)]]" restamp>
        <google-youtube
            video-id="[[_toVideoIdFilter(selectedSession.youtubeUrl)]]"
            height="100%" width="100%" fit
            autohide="1" controls="2" modestbranding="1" showinfo="0"
            iv_load_policy="3" rel="0" autoplay="1"
            on-google-youtube-ready="onScheduleVideoReady"></google-youtube>
      </template>
      <div class="play__button__container" on-click="onVideoPlay"
           data-track-link$="{{selectedSession.youtubeUrl}}"
           hidden$="{{showSessionPlayButton(selectedSession)}}"
           layout vertical center-center fit>
        <h4>Watch video</h4>
      </div>
      <iron-image src="{{placeholderImage(selectedSession)}}"
                  placeholder="images/io15-color.png"
                  sizing="cover" preload fade fit></iron-image>
      <paper-fab icon="{{_computeSessionSavedIcon(selectedSession.*)}}"
                 mini="[[app.isPhoneSize]]"
                 class$="[[_addClass('active', selectedSession.saved)]]"
                 on-up="_onToggleSaveSession"></paper-fab>
    </div>
    <div class="session__info__section">
      <h2 class="session__title" tabindex="-1">{{selectedSession.title}}</h2>
      <h5 class="session__time">May <span>{{selectedSession.day}}</span> / <span>{{selectedSession.start}}</span><span hidden$="{{_equal('__keynote__', selectedSession.id)}}"> - {{selectedSession.end}}</span> / <span>{{selectedSession.room}}</span></h5>
      <h5 class="session__categories">{{_formatSessionTagsFilter(selectedSession.tags)}}</h5>
      <div class="session__desc">{{selectedSession.description}}</div>
      <div class="session__social" layout horizontal>
        <a href="#" target="_blank" class="share-icon" data-share-type="gplus"
           data-track-link="schedule-detail-share-gplus" on-click="openShareWindow">
          <iron-icon icon="io:post-gplus"></iron-icon>
        </a>
        <a href="#" target="_blank" class="share-icon" data-share-type="twitter"
           data-track-link="schedule-detail-share-twitter" on-click="openShareWindow">
          <iron-icon icon="io:post-twitter"></iron-icon>
        </a>
        <a href="#" target="_blank" class="share-icon" data-share-type="fb"
           data-track-link="schedule-detail-share-fb" on-click="openShareWindow">
          <iron-icon icon="io:post-facebook"></iron-icon>
        </a>
        <span class="session__livestream" flex
              hidden$="{{!selectedSession.isLivestream}}">Live streamed <iron-icon icon="io:videocam"></iron-icon>
        </span>
      </div>
    </div>
    <div class="session__info__section session__speakers"
         hidden$="{{!selectedSession.speakers.length}}">
      <h4>Speakers</h4>
      <div layout horizontal wrap>
        <template is="dom-repeat" items="{{selectedSession.speakers}}" as="speakerId">
          <div class="speaker__card" layout horizontal>
            <div><img src$="{{speakerProfilePic(app.scheduleData.speakers, speakerId)}}"
                      class="profilepic"></div>
            <div class="speaker__info" layout vertical flex>
              <span class="speaker__name">{{_propOfArrayItem(app.scheduleData.speakers, speakerId, 'name')}}</span>
              <span class="speaker__title">{{_propOfArrayItem(app.scheduleData.speakers, speakerId, 'company')}}</span>
              <div class="speaker__desc">{{_propOfArrayItem(app.scheduleData.speakers, speakerId, 'bio')}}</div>
              <div class="session__social" layout horizontal>
                <a href$="{{_propOfArrayItem(app.scheduleData.speakers, speakerId, 'plusoneUrl')}}" target="_blank" class="share-icon" hidden$="{{!_propOfArrayItem(app.scheduleData.speakers, speakerId, 'plusoneUrl')}}"><iron-icon icon="io:post-gplus"></iron-icon></a>
                <a href$="{{_propOfArrayItem(app.scheduleData.speakers, speakerId, 'twitterUrl')}}" target="_blank" class="share-icon" hidden$="{{!_propOfArrayItem(app.scheduleData.speakers, speakerId, 'twitterUrl')}}"><iron-icon icon="io:post-twitter"></iron-icon></a>
              </div>
            </div>
          </div>
        </template>

      </div>
    </div>

    <div class="session__info__section session__info__links card-content"
        layout horizontal justified$="{{app.isPhoneSize}}"
        hidden$="{{_computeHideSessionInfo(selectedSession)}}">
      <span class="anchor-like" role="link"
            on-click="onRelatedContent"
            data-track-link="schedule-detail-related"
            hidden$="{{!selectedSession.hasRelated}}"
            dialog-dismiss>View related content</span>
      <span class="anchor-like" role="link"
          on-click="onRateSession"
          data-track-link="schedule-rate-session"
          hidden$="{{_computeHideSessionRating(selectedSession)}}">Rate session</span>
      <span class="anchor-like-disabled" hidden$="{{!selectedSession.rated}}">Rating submitted</span>
    </div>
  </div>
</paper-dialog>

<paper-dialog id="ratePanel"
              class="session__rate"
              entry-animation="scale-up-animation"
              exit-animation="fade-out-animation"
              with-backdrop$="{{!app.isIOS}}">
  <div class="scrollable">
    <div class="session__info__section rate__header" layout horizontal center>
      <paper-icon-button icon="io:arrow-back" dialog-dismiss aria-label="Close session"></paper-icon-button>
      <span>Rate this session</span>
    </div>
    <div class="session__info__section">
      <h2 class="session__title" tabindex="-1">{{selectedSession.title}}</h2>
      <h5 class="session__authors">{{_speakerIdsToNameString(selectedSession.speakers)}}</h5>
    </div>
    <div class="session__info__section">
      <p>Session rating:</p>
      <div>
        <div>
          <paper-menu selected="{{answers.overall}}"
                      attr-for-selected="value" layout horizontal justified>
            <paper-icon-button value="1" icon="io:star" class="rate__icon"></paper-icon-button>
            <paper-icon-button value="2" icon="io:star" class="rate__icon"></paper-icon-button>
            <paper-icon-button value="3" icon="io:star" class="rate__icon"></paper-icon-button>
            <paper-icon-button value="4" icon="io:star" class="rate__icon"></paper-icon-button>
            <paper-icon-button value="5" icon="io:star" class="rate__icon"></paper-icon-button>
          </paper-menu>
        </div>
        <div class="rate__hint" layout horizontal justified>
          <span>Not so awesome</span>
          <span>Awesome</span>
        </div>
      </div>
    </div>
    <div class="session__info__section">
      <p>How relevant was this session to your projects?</p>
      <div>
        <div>
          <paper-menu selected="{{answers.relevance}}"
                      attr-for-selected="value" layout horizontal justified>
            <paper-icon-button value="1" icon="io:star" class="rate__icon rate__icon-empty rate__icon-1"></paper-icon-button>
            <paper-icon-button value="2" icon="io:star" class="rate__icon rate__icon-empty rate__icon-2"></paper-icon-button>
            <paper-icon-button value="3" icon="io:star" class="rate__icon rate__icon-empty rate__icon-3"></paper-icon-button>
            <paper-icon-button value="4" icon="io:star" class="rate__icon rate__icon-empty rate__icon-4"></paper-icon-button>
            <paper-icon-button value="5" icon="io:star" class="rate__icon rate__icon-empty rate__icon-5"></paper-icon-button>
          </paper-menu>
        </div>
        <div class="rate__hint" layout horizontal justified>
          <span>Not at all</span>
          <span>Extremely</span>
        </div>
      </div>
    </div>
    <div class="session__info__section">
      <p>Based on the description/my expectations, the content was:</p>
      <div>
        <div>
          <paper-menu selected="{{answers.content}}"
                      attr-for-selected="value" layout horizontal justified>
            <paper-icon-button value="1" icon="io:star" class="rate__icon rate__icon-empty rate__icon-1"></paper-icon-button>
            <paper-icon-button value="2" icon="io:star" class="rate__icon rate__icon-empty rate__icon-2"></paper-icon-button>
            <paper-icon-button value="3" icon="io:star" class="rate__icon rate__icon-empty rate__icon-3"></paper-icon-button>
            <paper-icon-button value="4" icon="io:star" class="rate__icon rate__icon-empty rate__icon-4"></paper-icon-button>
            <paper-icon-button value="5" icon="io:star" class="rate__icon rate__icon-empty rate__icon-5"></paper-icon-button>
          </paper-menu>
        </div>
        <div class="rate__hint" layout horizontal justified>
          <span>Too basic</span>
          <span>Too advanced</span>
        </div>
      </div>
    </div>
    <div class="session__info__section">
      <p>Speaker quality:</p>
      <div>
        <div>
          <paper-menu selected="{{answers.speaker}}"
                      attr-for-selected="value" layout horizontal justified>
            <paper-icon-button value="1" icon="io:star" class="rate__icon rate__icon-empty rate__icon-1"></paper-icon-button>
            <paper-icon-button value="2" icon="io:star" class="rate__icon rate__icon-empty rate__icon-2"></paper-icon-button>
            <paper-icon-button value="3" icon="io:star" class="rate__icon rate__icon-empty rate__icon-3"></paper-icon-button>
            <paper-icon-button value="4" icon="io:star" class="rate__icon rate__icon-empty rate__icon-4"></paper-icon-button>
            <paper-icon-button value="5" icon="io:star" class="rate__icon rate__icon-empty rate__icon-5"></paper-icon-button>
          </paper-menu>
        </div>
        <div class="rate__hint" layout horizontal justified>
          <span>Poor</span>
          <span>Outstanding</span>
        </div>
      </div>
    </div>
    <div class="session__info__section session__info__links card-content">
      <span class="anchor-like" role="link"
          disabled$="[[_computeDisableRateSession(answers.*)]]"
          on-click="onRateSessionSubmit"
          data-track-link="schedule-rate-submit"
          dialog-dismiss$="[[!_computeDisableRateSession(answers.*)]]">Submit</span>
    </div>
  </div>
</paper-dialog>


<div class="card__container">

  <div class="card">

    <div class="subpage__container">

      <div class="subpage__nav bg-cyan-400" layout horizontal center justified>
        <template is="dom-if" if="[[!app.isPhoneSize]]">
          <paper-tabs id="subpage-tabs" class="white"
                      attr-for-selected="label"
                      selected="[[selectedSubpage]]">
            <paper-tab label="agenda" role="">
              <a href="#agenda" data-track-link="schedule-agenda" data-ajax-link
                                layout horizontal center-center>Agenda</a>
            </paper-tab>
            <paper-tab label="day1" role="">
              <a href="#day1" data-track-link="schedule-day1" data-ajax-link
                              layout horizontal center-center>May 18</a>
            </paper-tab>
            <paper-tab label="day2" role="">
              <a href="#day2" data-track-link="schedule-day2" data-ajax-link
                              layout horizontal center-center>May 19</a>
            </paper-tab>
            <paper-tab label="day3" role="">
              <a href="#day3" data-track-link="schedule-day3" data-ajax-link
                              layout horizontal center-center>May 20</a>
            </paper-tab>
            <paper-tab label="myschedule" role="">
              <a href="#myschedule" data-track-link="schedule-mysched" data-ajax-link
                                    layout horizontal center-center>My Schedule</a>
            </paper-tab>
          </paper-tabs>
        </template>

        <template is="dom-if" if="[[_showDaySelector(app.isPhoneSize, selectedSubpage)]]">
          <paper-dropdown-menu horizontal-align="left"
                               no-label-float noink>
            <paper-listbox class="dropdown-content"
                          attr-for-selected="label"
                          selected="[[selectedSubpage]]">
              <paper-item label="agenda">
                <a href="#agenda" data-track-link="schedule-agenda" data-ajax-link
                                  layout horizontal center-center>Agenda</a>
              </paper-item>
              <paper-item label="day1">
                <a href="#day1" data-track-link="schedule-day1" data-ajax-link
                                layout horizontal center-center>May 18</a>
              </paper-item>
              <paper-item label="day2">
                <a href="#day2" data-track-link="schedule-day2" data-ajax-link
                                layout horizontal center-center>May 19</a>
              </paper-item>
              <paper-item label="day3">
                <a href="#day3" data-track-link="schedule-day3" data-ajax-link
                                layout horizontal center-center>May 20</a>
              </paper-item>
            </paper-listbox>
          </paper-dropdown-menu>
        </template>

        <template is="dom-if" if="[[_showMyScheduleArrow(app.isPhoneSize, selectedSubpage)]]">
          <div class="subpage__nav--myscheduleback" layout horizontal center>
            <paper-icon-button icon="io:arrow-back"
                               aria-label="Close My Schedule"
                               on-tap="_goBack"></paper-icon-button>
            <span>My Schedule</span>
          </div>
        </template>

        <div layout horizontal center>
          <div class="meta-myschedue-button"
               hidden$="[[!app.isPhoneSize]]"
               disabled$="[[_disableMyScheduleGuy(selectedSubpage)]]">
            <a href="#myschedule" data-track-link="schedule-mysched" data-ajax-link>
              <paper-icon-button icon="io:person" aria-label="My Schedule"></paper-icon-button>
            </a>
          </div>

          <div class="meta-filter" layout horizontal center
               disabled$="[[_disableFiltering(selectedSubpage)]]"
               on-tap="toggleFilters">
            <span hidden$="[[app.isPhoneSize]]">Filter</span>
            <paper-icon-button icon="io:filter-list" aria-label="Filter list"></paper-icon-button>
          </div>
        </div>
      </div>

      <section class$="subpage-agenda subpage__content bg-bluegrey-50-20 {{_applyActiveClassWhenSubpage(selectedSubpage, 'agenda')}}">
        <section class="slide-up">
          <div class="card__container bg-cyan-200">
            <div class="card">
              <div class="card-content max-width-800 text-justified">
                I/O'16 takes place over the course of 3 days in May, from the 18th-20th. On-site
                badge pick-up is available Wednesday, May 18 from 9-10AM. Below is an overview of the
                activities taking place over the course of the conference.
              </div>
            </div>
          </div>
          <template is="dom-if"
                    if="[[_isSelectedSubpage(selectedSubpage, 'agenda')]]">
            <template is="dom-repeat" items="[[agenda]]" as="day">
              <io-agenda app="[[app]]"
                         day="[[day.day]]"
                         start="[[day.start]]"
                         end="[[day.end]]"
                         color="[[day.color]]"
                         events="[[day.events]]"></io-agenda>
            </template>
          </template>
        </section>
      </section>

      <section class$="subpage-day1 subpage-day2 subpage-myschedule subpage__content {{_applyActiveClassWhenNotSubpage(selectedSubpage, 'agenda')}}">

        <div class="slide-up">
          <section class="bg-bluegrey-50-20">
            <io-schedule id="scheduleEl"
              app="[[app]]"
              day="[[selectedSubpage]]"
              sessions="{{app.scheduleData.sessions}}"
              saved-sessions="{{app.savedSessions}}"
              session-themes="[[app.filterThemes]]"
              session-topics="[[app.filterTopics]]"
              session-types="[[app.filterSessionTypes]]"
              filters="{{sessionURLFilters}}"
              on-session-bookmark="_onToggleSaveSession"
              on-session-select="openSession"
              gmt-day-one="[[date]]"></io-schedule>
          </section>
        </div>
      </section>
    </div>

  </div> <!-- .card -->

</div> <!-- .card__container -->

<div class="io__hash io__hash-bottom" aria-label="I/O hash tag"></div>

</template>
<script>
(function () {
  'use strict';

  var SUBTAB_SELECTOR = '#subpage-tabs a';
  var pageIsDeepLinked_ = false; // Flag to not double-record page view on deep linking into session.

  function getFiltersFromURL(opt_parsedUrl) {
    var parsedUrl = opt_parsedUrl || IOWA.Router.parseUrl(window.location.toString());
    var filters = [];
    if (parsedUrl.params.filters) {
      filters = parsedUrl.params.filters.split(',');
    }
    return filters;
  }

  Polymer({

    is: 'io-schedule-page',

    behaviors: [IOBehaviors.PageBehavior],

    properties: {
      /**
       * The target date for I/O to start. Should be specified in ISO 8601
       * format, e.g. `May 10 2016 09:00:00 GMT-0700 (PDT)`.
       */
      date: {
        type: String,
        value: 'May 10 2016 09:00:00 GMT-0700 (PDT)'
      },

      /**
       * The selected subpage/tab.
       */
      selectedSubpage: {
        type: String,
        value: 'day1'
      },

      /**
       * Selected session to show details for.
       */
      selectedSession: {
        type: Object,
        value: null
      },

      _startScheduleVideo: {
        type: Boolean,
        value: false
      },

      /**
       * Array of Objects representing the agenda to display.  Each Object represents a day's agenda
       * in the following format:
       *
       * {
       *   day: 'Wednesday, May 18', // Title describing day
       *   start: 7, // Agenda start time
       *   end: 22, // Agenda end time
       *   color: '#ff8a80', // Highlight color for gant bars
       *   events: [{ // Array of event objects
       *     name: 'Badge pick-up', // name of event
       *     start: 9, // Start time in 24h format 13.5 = 1:30 pm
       *     end: 17, // End time in 24h format
       *   }]
       * }
       */
      agenda: {
        type: Array,
        readOnly: true,
        value: [{
          day: 'Wednesday, May 18',
          start: 7,
          end: 22,
          color: '#ff8a80',
          events: [{
            name: 'Badge pick-up',
            start: 9,
            end: 10
          }]
        }, {
          day: 'Thursday, May 19',
          start: 7,
          end: 22,
          color: '#80deea',
          events: [{
            name: 'Breakfast',
            start: 7,
            end: 8
          }, {
            name: 'Badge pick-up',
            start: 7,
            end: 17
          }, {
            name: 'Pre-keynote show',
            start: 9,
            end: 9.5
          }, {
            name: 'Keynote',
            start: 9.5,
            end: 10.5
          }, {
            name: 'Lunch',
            start: 12,
            end: 14
          }, {
            name: 'Sessions',
            start: 12,
            end: 17
          }, {
            name: 'Code Labs',
            start: 12,
            end: 17
          }, {
            name: 'Sandbox',
            start: 12,
            end: 17
          }, {
            name: 'After Hours',
            start: 18.5,
            end: 22
          }]
        }, {
          day: 'Friday, May 20',
          start: 7,
          end: 22,
          color: '#7986cb',
          events: [{
            name: 'Breakfast',
            start: 7,
            end: 9
          }, {
            name: 'Badge pick-up',
            start: 8,
            end: 15
          }, {
            name: 'Sessions',
            start: 9,
            end: 17
          }, {
            name: 'Lunch',
            start: 12,
            end: 14
          }, {
            name: 'Code Labs',
            start: 9,
            end: 17
          }, {
            name: 'Sandbox',
            start: 9,
            end: 17
          }]
        }]
      }
    },

    title: 'Schedule',
    name: 'schedule',

    attached: function() {
      // TODO: check that this is still needed in paper-tabs.
      IOWA.A11y.addFocusStates(SUBTAB_SELECTOR);

      this.listen(window, 'popstate', 'sessionDetailsPopstateHandler');


var subnav = header.querySelector('.subpage__nav');
var pageSubnav = Polymer.dom(this.root).querySelector('.subpage__nav')
var mastheadContainer = Polymer.dom(this.root).querySelector('.masthead-container')

  IOWA.Elements.ScrollContainer.addEventListener('scroll', function(e) {
    var pageSubnavReachedTop = e.target.scrollTop - header.clientHeight -
                               mastheadContainer.clientHeight >= 0;
    var headerOnScreen = header.isOnScreen();

//console.log(headerOnScreen, atTop);
    if (pageSubnavReachedTop) {
      subnav.style.display = 'block';
    } else {
      subnav.style.display = 'none';
    }
  });
    },

    detached: function() {
      IOWA.A11y.removeFocusStates(SUBTAB_SELECTOR);
      this.unlisten(window, 'popstate', 'sessionDetailsPopstateHandler');
    },

    onPageTransitionDone: function(e) {
      // Deep link into schedule tab.
      var parsedUrl = IOWA.Router.parseUrl(window.location.toString());
      this.sessionURLFilters = getFiltersFromURL(parsedUrl);
      // TODO: find way to elegantly move into io-schedule element.
      this.$.scheduleEl._deepLinkRadioButtons();

      // Deep link into session. First, try to pull session id from the
      // ?sid= param. If that isn't present, use the parsed id from the fragment.
      var sessionId = IOWA.Util.getURLParameter('sid') || parsedUrl.resourceId;
      if (sessionId) {
        pageIsDeepLinked_ = true;
        this.openSession(IOWA.Schedule.getSessionById(sessionId));
      } else {
        pageIsDeepLinked_ = false;
      }

      this.async(function() {
        IOWA.Elements.Template.initFabScroll();
      }, 200);
    },

    onSubpageTransitionDone: function() {
      // Reset FAB position after new DOM is set.
      IOWA.Elements.Template.initFabScroll();
    },

    sessionDetailsPopstateHandler: function(e) {
      this.sessionURLFilters = getFiltersFromURL();
      if (!this.$.sessionDetails.opened && this.selectedSession) {
        this.$.sessionDetails.open();
      } else {
        this.$.sessionDetails.close();
      }
    },

    openSession: function(sessionOrEvent) {
      if (!sessionOrEvent) {
       return;
      }
      this.selectedSession = (
          sessionOrEvent.detail ? sessionOrEvent.detail.session :
                                  sessionOrEvent);
      this.$.sessionDetails.open();
    },

    toggleFilters: function() {
      this.$.scheduleEl.showFilters = !this.$.scheduleEl.showFilters;
    },

    onSessionDetailsClose: function(e) {
      // Remove session id hash from URL.
      var search = IOWA.Util.removeSearchParam(window.location.search, 'sid');
      var url = IOWA.Router.composeUrl(
          'schedule', this.selectedSubpage, '', search);
      history.replaceState({}, null, url);

      document.title = 'Schedule';
      pageIsDeepLinked_ = false;

      // Reset video state.
      var video = this.$.sessionDetails.querySelector('google-youtube')
      if (video) {
        video.pause();
      }
      this.$.sessionDetails.querySelector('iron-image').classList.remove('fadeout');
      this.$.sessionDetails.querySelector('.play__button__container').classList.remove('fadeout');
      this._startScheduleVideo = false;
    },

    onSessionDetailsOpen: function() {
      //this.$.sessionDetails.querySelector('.session__title').focus();

      document.title = this.selectedSession.title + ' - Google I/O Schedule';

      // Update URL with deep link. Always ensure sid parameter is set.
      var sessionId = this.selectedSession.id;

      var search = IOWA.Util.setSearchParam(location.search, 'sid', sessionId);
      var url = IOWA.Router.composeUrl('schedule', this.selectedSubpage,
                                       sessionId, search);
      history.pushState({}, null, url);

      // Report session detail as pageview in GA, only if we're not loading
      // the page from a session detail deep link. Don't want to double record.
      if (!pageIsDeepLinked_) {
        IOWA.Analytics.trackPageView(location.pathname + location.hash);
      }
    },

    _onToggleSaveSession: function(e, detail) {
      e.stopPropagation();
      // Bookmarking came from <io-schedule> event. We're passed a session object.
      // Otherwise, there's a session detail card up and this.selectedSession
      // is already set.
      if (detail && detail.session) {
        this.selectedSession = detail.session;
      }
      var saved;
      if (detail && detail.saved !== undefined) {
        // If event is triggered from a checkbox we can set the value directly.
        saved = detail.saved;
      } else {
        // If even tis triggered from a FAB we toggle.
        saved = !this.selectedSession.saved;
      }
      IOWA.Schedule.saveSession(this.selectedSession.id, saved).then(function() {
        this.set('selectedSession.saved', saved);
        IOWA.Schedule.bookmarkSessionNotification(saved);
      }.bind(this));
    },

    onRelatedContent: function(e, detail) {
      e.stopPropagation();

      var target = Polymer.dom(e).rootTarget;

      if (target && target.hasAttribute(this.app.ANALYTICS_LINK_ATTR)) {
        IOWA.Analytics.trackEvent('link', 'click',
            target.getAttribute(this.app.ANALYTICS_LINK_ATTR));
      }
      this.sessionURLFilters = [this.selectedSession.id];
    },

    onRateSession: function(e, detail) {
      var target = Polymer.dom(e).rootTarget;

      if (target && target.hasAttribute(this.app.ANALYTICS_LINK_ATTR)) {
        IOWA.Analytics.trackEvent('link', 'click',
            target.getAttribute(this.app.ANALYTICS_LINK_ATTR));
      }
      this.answers = {}; // Reset answers.
      this.$.ratePanel.open();
    },

    onRateSessionSubmit: function(e, detail) {
      var target = Polymer.dom(e).rootTarget;

      if (target.hasAttribute('disabled')) {
        return;
      }
      IOWA.Schedule.saveSurvey(this.selectedSession.id, this.answers).then(function() {
        this.set('selectedSession.rated', true);
      }.bind(this));
    },

    onScheduleVideoReady: function(e, detail) {
      this.$.sessionDetails.querySelector('iron-image').classList.add('fadeout');
      this.$.sessionDetails.querySelector('.play__button__container').classList.add('fadeout');
    },

    onVideoPlay: function(e, detail) {
      e.stopPropagation();
      e.preventDefault();

      this._startScheduleVideo = true;

      var target = Polymer.dom(e).rootTarget;
      if (target.hasAttribute(this.app.ANALYTICS_LINK_ATTR)) {
        var videoUrl = target.getAttribute(this.app.ANALYTICS_LINK_ATTR);
        IOWA.Analytics.trackEvent('schedule', 'video play', videoUrl);
        IOWA.IOFirebase.markVideoAsViewed(videoUrl);
      }
    },

    sessionHasVideo: function(startVideo, isLivestream, youtubeUrl) {
      return startVideo && !isLivestream && youtubeUrl;
    },

    showSessionPlayButton: function(selectedSession) {
      if (!selectedSession) {
        return false;
      }
      return selectedSession.isLivestream || !selectedSession.youtubeUrl;
    },

    placeholderImage: function(selectedSession) {
      if (selectedSession && selectedSession.photoUrl) {
        return selectedSession.photoUrl;
      }
      return 'images/schedule/session_placeholder.jpg';
    },

    speakerProfilePic: function(speakers, id) {
      if (speakers && speakers[id].thumbnailUrl) {
        return speakers[id].thumbnailUrl;
      }
      return 'images/schedule/profile_placeholder.png';
    },

    _computeHideSessionInfo: function(session) {
      if (session === null) {
        return false;
      }
      var isFinished = new Date(session.endTimestamp) < Date.now();
      return session.id === '__afterhours__' ||
             (!isFinished && !session.hasRelated);
    },

    _computeHideSessionRating: function(session) {
      if (session === null) {
        return false;
      }
      var isFinished = new Date(session.endTimestamp) < Date.now();
      return session.rated || session.id == '__afterhours__' || !isFinished;
    },

    _computeSessionSavedIcon: function(selectedSession) {
      return selectedSession.value && selectedSession.value.saved ? 'io:check' : 'io:add';
    },

    _computeDisableRateSession: function(answersRecord) {
      return !this.answers.overall && !this.answers.relevance &&
             !this.answers.content && !this.answers.speaker;
    },

    _speakerIdsToNameString: function(speakers) {
      if (!speakers) {
        return '';
      }
      if (typeof speakers === 'string') {
        return speakers; // speakers is already a "," separated string.
      }
      return speakers.map(function(speakerId) {
        return this.app.scheduleData.speakers[speakerId].name;
      }.bind(this)).sort().join(', ');
    },

    _formatSessionTagsFilter: function(tagList) {
      if (!tagList) {
        return;
      }
      var list = tagList.map(function(tag) {
        tag = this.app.scheduleData.tags[tag];
        return tag ? tag.name : '';
      }, this);
      return list.join(', ');
    },

    _hideSessionFilters: function(isPhoneSize, selectedSubpage) {
      return !isPhoneSize || selectedSubpage === 'myschedule';
    },

    _applyActiveClassWhenNotSubpage: function(selectedSubpage, subpageName) {
      return this._addClass('active', selectedSubpage !== subpageName);
    },

    _disableFiltering: function(selectedSubpage) {
      var hide = selectedSubpage === 'myschedule' || selectedSubpage === 'agenda';
      if (hide) {
        this.$.scheduleEl.showFilters = false;
      }
      return hide;
    },

    _showDaySelector: function(isMobile, selectedSubpage) {
      return isMobile && selectedSubpage !== 'myschedule';
    },

    _showMyScheduleArrow: function(isMobile, selectedSubpage) {
      return isMobile && selectedSubpage === 'myschedule';
    },

    _disableMyScheduleGuy: function(selectedSubpage) {
      return selectedSubpage === 'myschedule';
    },

    _goBack: function(e) {
      e.stopPropagation();
      e.preventDefault();
      window.history.go(-1);
    }

  });

}());
</script>
</dom-module>
