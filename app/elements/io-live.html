<!--
Copyright 2016 Google Inc. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at
  http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->


<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/google-youtube/google-youtube.html">
<link rel="import" href="../bower_components/neon-animation/neon-animated-pages.html">
<link rel="import" href="../bower_components/neon-animatio/animates/slide-from-right-animation.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-label/iron-label.html">
<link rel="import" href="../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog-transition.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="io-radio-button.html">
<link rel="import" href="social-post.html">

<link rel="import" href="shared-app-styles.html">
<link rel="import" href="PageBehavior.html">

<!--
The `<io-live>` provides the Google I/O live stream experience.
-->
<!--
Fired when the mode changes.

@event io-live-mode
-->
<dom-module id="io-live">
<link rel="import" type="css" href="io-live.css">
<template>
  <style include="shared-app-styles">
    :host {
      display: block;
      background-color: #00BCD4;
      font-size: 16px;
    }
    :host([mode="before"]) .bottom__bar {
      bottom: 16px;
    }
    paper-tabs.white {
      color: white;
    }
    paper-tabs.white::shadow #selectionBar {
      background-color: #fff;
    }
    paper-tabs.white paper-tab::shadow .tab-content {
      margin: 0;
    }
    paper-tabs.white paper-tab::shadow #ink {
      color: rgba(255,255,255,0.5);
    }
    social-post::shadow header {
      margin-bottom: 8px;
    }
    social-post::shadow .timestamp,
    social-post::shadow a {
      font-size: 14px;
    }
    #sessiondetails::shadow #scroller {
      padding: 0;
    }
  </style>

  <div class="bottom__bar" layout="" horizontal="" center="" justified="" end$="{{isiOS}}">
    <div flex="">
      <template is="dom-if" if="{{_computeIf(_MODES, mode)}}">
        <content></content>
      </template>
    </div>

    <paper-fab id="schedfab" icon="picture-in-picture" aria-label="My schedule" title="My schedule" on-tap="onFabClick"></paper-fab>

    <!-- <template if="{{afterKeynote}}">
      <div class="keynote__banner card {{ {on: afterKeynote && openWidget} | tokenList }}" layout horizontal on-tap="{{onPlayKeynote}}">
        <div class="card-content" layout horizontal center>
          <div><core-icon icon="io:play-circle-fill" self-center></core-icon> Watch the keynote</div>
        </div>
      </div>
    </template> -->

    <div id="livewidget" on-transitionend="onFabTransition">

      <paper-dialog id="sessiondetails" transition="paper-dialog-transition-bottom" layered="false" on-core-overlay-open-completed="onSessionDetailsOpen">
        <paper-icon-button icon="arrow-back" core-overlay-toggle="" aria-label="Close session"></paper-icon-button>
        <div class="card__photo" relative="">
          <iron-image src="{{_computeSrc(selectedSession)}}" placeholder="images/io15-color.png" sizing="cover" preload="" fade="" fit=""></iron-image>
          <paper-fab icon="{{_computeIcon(selectedSession)}}" mini="" on-up="onToggleSaveSession" class$="{{_computeClass(selectedSession)}}" disabled$="{{fetchingUserData}}"></paper-fab>
          <paper-progress indeterminate="" hidden$="{{!fetchingUserData}}"></paper-progress>
        </div>
        <div class="session__info__section">
          <h2 class="session__title" tabindex="-1">{{selectedSession.title}}</h2>
          <div class="session__desc">{{selectedSession.description}}</div>
        </div>
        <div class="session__info__section session__speakers" hidden$="{{!selectedSession.speakers.length}}">
          <h3>Speakers</h3>
          <div layout="" horizontal="" wrap="">
            <template is="dom-repeat" items="{{selectedSession.speakers}}" as="speakerId">
              <div class="speaker__card" layout="" horizontal="">
                <div><img _src="{{_compute_src(speakerId, speakers)}}" class="profile__pic"></div>
                <div class="speaker__info" layout="" vertical="" flex="">
                  <span class="speaker__name">{{_computeExpression3(speakerId, speakers)}}</span>
                  <span class="speaker__title">{{_computeExpression4(speakerId, speakers)}}</span>
                  <div class="speaker__desc">{{_computeExpression5(speakerId, speakers)}}</div>
                  <div class="session__social" layout="" horizontal="">
                    <a target="_blank" class="share-icon" href$="{{_computeHref(speakerId, speakers)}}" hidden$="{{_computeHref3(speakerId, speakers)}}"><iron-icon icon="io:post-gplus"></iron-icon></a>
                    <a target="_blank" class="share-icon" href$="{{_computeHref(speakerId, speakers)}}" hidden$="{{_computeHidden2(speakerId, speakers)}}"><iron-icon icon="io:post-twitter"></iron-icon></a>
                  </div>
                </div>
              </div>
            </template>

          </div>
        </div>
        <div class="session__info__section session__info__links card-content" hidden$="{{!selectedSession.hasRelated}}">
          <span class="anchor-like" on-click="onRelatedContent" data-track-link="schedule-detail-related" core-overlay-toggle="">View related content</span>
        </div>
      </paper-dialog>

      <div class="middle-content-section bg-dark-grey" layout="" vertical="">

        <div class="widget-nav" layout="" horizontal="" center="" self-end="">
          <paper-icon-button icon="close" on-tap="closeFab"></paper-icon-button>
        </div>

        <paper-tabs class="white" valueattr="label" selected="{{selectedTab}}">
          <paper-tab label="live" role="">I/O Live</paper-tab>
          <paper-tab label="schedule" role="" disabled$="{{_computeIf2(_MODES, mode)}}">Live schedule</paper-tab>
          <paper-tab label="hash" role="">#io15</paper-tab>
        </paper-tabs>

        <neon-animated-pages transitions="slide-from-right" selected="{{selectedTab}}" valueattr="label" fit="">
          <section class="schedule__content" label="live" layout="" vertical="">

            <template is="dom-if" if="{{_computeIf(_MODES, mode)}}">
              <div class="card__photo card__photo--live"></div>
              <div class="card card__photo--live-desc">
                <div class="card-content">Our 8th annual Google I/O developer conference will kick-off with a keynote hosted by our Senior Vice-President of Products, Sundar Pichai.</div>
              </div>
            </template>

            <template is="dom-if" if="{{duringKeynote}}">
              <div layout="" vertical="" flex="">
                <div class="card__photo card__photo--live" flex="" layout="" vertical="" center-center="">
                  <img src="../images/play-video-button.png">
                  <h4>Keynote in progress</h4>
                </div>
              </div>
            </template>

            <template is="dom-if" if="{{_computeIf3(_MODES, currentLiveSessions, mode)}}">
              <div layout="" vertical="">
                <div class="card">
                  <div class="card-content">
                    <h2>I/O Live will resume soon</h2>
                    <div>In the meantime, browse the live schedule and create your own I/O Live playlist.</div>
                  </div>
                </div>
              </div>
            </template>

            <template is="dom-if" if="{{_computeIf2(_MODES, mode)}}">
              <div layout="" vertical="" flex="">
                <div class="card" layout="" vertical="" flex="">
                  <div class="card-content">
                    <h2>Thanks for watching I/O 2015</h2>
                    <div>Missed a session? No worries! You'll be able to watch all of the recorded sessions soon.</div>
                  </div>
                </div>
              </div>
            </template>

            <div class="card schedule-rows" layout="" vertical="" flex="" hidden$="{{duringKeynote}}">

              <paper-menu id="live-channel-menu" class="schedule__content" valueattr="videoid" selected="{{selectedVideoId}}">
                <template is="dom-if" items="{{currentLiveSessions}}" as="session" if="{{!duringKeynote}}">
                  <div class="schedule-row" layout="" horizontal="" center="" videoid="{{session.youtubeUrl}}">
                    <div>
                      <img _src="{{generateSpeakerImage(session)}}" class="profile__pic">
                    </div>
                    <div class="session__detail" layout="" vertical="" flex="">
                      <span class="session__title" auto-vertical="" two="" title="{{session.title}}" flex$="{{!isPhoneSize}}">
                        <span>{{session.title}}</span>
                      </span>
                      <div class="schedule-speakers">{{speakerIdsToNameString(session.speakers)}}</div>
                    </div>
                    <iron-icon icon="{{_computeIcon(selectedVideoId, session)}}" self-center="{{_computeIcon2(selectedVideoId, session)}}"></iron-icon>
                  </div>
                </template>
                <template is="dom-repeat" items="{{missingChannels}}" as="channel">
                  <div class="schedule-row" layout="" horizontal="" center="" videoid="{{channel.videoId}}">
                    <div>
                      <img src="{{_computeSrc(channel)}}" class="{{_computeSrc2(channel)}}">
                    </div>
                    <div class="session__detail" layout="" vertical="" flex="">
                      <span class="session__title" auto-vertical="" two="" title="{{_computeTitle(channel)}}" flex$="{{!isPhoneSize}}">
                        Channel <span>{{channel.label}}</span>
                      </span>
                    </div>
                    <iron-icon icon="{{_computeIcon(channel, selectedVideoId)}}" self-center="{{_computeIcon3(channel, selectedVideoId)}}"></iron-icon>
                  </div>
                </template>
              </paper-menu>
            </div>

          </section>
          <section class="schedule__content" label="schedule" layout="" vertical="">

            <template is="dom-if" if="{{_computeIf3(_MODES, currentLiveSessions, mode)}}">
              <div layout="" vertical="" flex="">
                <div class="card" fit="">
                  <div class="card-content">
                    <h2>No live sessions</h2>
                    <div>In the meantime, browse the live schedule and create your own I/O Live playlist.</div>
                  </div>
                </div>
              </div>
            </template>

            <div class="card schedule-rows" layout="" vertical="">
              <template is="dom-repeat" items="{{filterHappenedSessions(todaysLiveSessions)}}" as="session">
                <div class="card-content" hidden$="{{!session.firstOfBlockForLivestream}}">
                  <h4>{{session.block}}</h4>
                </div>
                <div class="schedule-row" layout="" horizontal="">
                  <io-radio-button toggles="" on-change="{{_computeId(session)}}" aria-labelledby$="{{_computeAria-labelledby(session)}}" checked$="{{session.saved}}"></io-radio-button>
                  <div layout="" vertical="" flex="" tabindex="0">
                    <span id="{{_computeId(session)}}" class="schedule-title" auto-vertical="" two="" title="{{session.title}}" on-click="openSession" flex$="{{!isPhoneSize}}">
                      <span>{{session.title}}</span>
                    </span>
                    <div class="schedule-speakers">{{speakerIdsToNameString(session.speakers)}}</div>
                  </div>
                </div>
              </template>
            </div>

            <div class="card card__bottom-links">
              <paper-progress indeterminate="" fit="" hidden$="{{!fetchingUserData}}"></paper-progress>
              <div class="card-content" layout="" horizontal="" justified="">
                <a data-ajax-link="" data-track-link="live-fullschedule" href$="{{_computeHref(dayView)}}">Full schedule</a>
                <a data-ajax-link="" data-track-link="{{_computeHref2()}}" href$="{{_computeHref()}}">My schedule</a>
              </div>
            </div>

          </section>
          <section id="hashtab" label="hash">
            <div class="card">
              <div class="card-content social__feed" layout="" vertical="">
                <template is="dom-repeat" items="{{socialPosts}}" as="post">
                  <social-post kind="{{post.kind}}" author="{{post.author}}" url="{{post.url}}" text="{{post.text}}" when="{{post.when}}" media="{{post.media}}">
                  </social-post>
                </template>
              </div>
            </div>
          </section>
        </neon-animated-pages>

      </div>

    </div>

  </div>

  <div id="livecontainer">

    <template is="dom-if" if="{{_computeIf4(_MODES, mode)}}">
      <div class="fullvideo__container" fit="">
        <google-youtube video-id="{{selectedVideoId}}" height="100%" width="100%" fit="" autohide="1" controls="2" modestbranding="1" showinfo="0" iv_load_policy="3" rel="0" autoplay="1" on-google-youtube-ready="onVideoReady" on-google-youtube-state-change="onStateChange"></google-youtube>
      </div>
    </template>

  </div>

</template>
<script>
  Polymer({
    is: 'io-live',
    properties: {
      _MODES: {
        type: Object,
        value: function () {
          return {
            LIVE: 'live',
            BEFORE: 'before',
            AFTER: 'after'
          };
        }
      },
      _refreshSessionTimeout: { value: null },
      _videoReady: {
        type: Boolean,
        value: false
      },
      /**
       * True if the keynote has already passed.
       *
       * @property afterKeynote
       * @type Boolean
       * @default false
       */
      afterKeynote: {
        type: Boolean,
        value: false,
        notify: true
      },
      /**
       * True if the schedule FAB should auto-open when the element is loaded.
       *
       * @property autoOpenFab
       * @type Boolean
       * @default false
       */
      autoOpenFab: {
        type: Boolean,
        value: false,
        notify: true,
        observer: 'autoOpenFabChanged'
      },
      /**
       * Current day to display schedule information for. This calculated from
       * the `date` property. For example, "May 18 2016 09:00:00 GMT-0700 (PDT)"
       * would be 28.
       *
       * @property currentDay
       * @type number
       */
      currentDay: {
        value: null,
        notify: true
      },
      /**
       * List of currently playing live sessions.
       *
       * @property currentLiveSessions
       * @type Array
       * @default null
       */
      currentLiveSessions: {
        value: null,
        notify: true
      },
      /**
       * The target date for the event. Should be specified in ISO 8601
       * format, e.g. 'May 18 2016 09:30:00 GMT-0700 (PDT)'.
       *
       * @attribute date
       * @type string
       * @default 'May 18 2016 09:30:00 GMT-0700 (PDT)'
       */
      date: {
        type: String,
        value: 'May 18 2016 09:30:00 GMT-0700 (PDT)',
        notify: true,
        observer: 'dateChanged'
      },
      /**
       * Current day of IO.
       *
       * @property dayView
       * @type number
       * @default 1
       */
      dayView: {
        type: Number,
        value: 1,
        notify: true
      },
      /**
       * True if the current live streaming videos includes the keynote.
       *
       * @property duringKeynote
       * @type Boolean
       * @default false
       */
      duringKeynote: {
        type: Boolean,
        value: false,
        notify: true
      },
      /**
       * Whether fetching user data is in progress.
       *
       * @attribute fetchingUserData
       * @type Boolean
       * @default false
       */
      fetchingUserData: {
        type: Boolean,
        value: false,
        notify: true
      },
      isiOS: {
        type: Boolean,
        value: false
      },
      /**
       * List of live stream YT video channel ids.
       *
       * @attribute liveStreamChannelIds
       * @type Array
       * @default null
       */
      liveStreamChannelIds: {
        value: null,
        notify: true
      },
      /**
       * The mode of operation for the live embed. 'before' is before the event
       * starts (e.g. before `date`) and a countdown is shown leading up to the
       * event. 'live' signifies the event has already started and the live
       * stream video mode should be shown. 'after' is after the event.
       *
       * @attribute mode
       * @type string
       * @default null
       */
      mode: {
        type: String,
        value: '',
        notify: true,
        observer: 'modeChanged',
        reflectToAttribute: true
      },
      /**
       * If in live mode, the FAB is open when true.
       *
       * @property openWidget
       * @type bool
       * @default false
       */
      openWidget: {
        type: Boolean,
        value: false,
        notify: true,
        observer: 'openWidgetChanged',
        reflectToAttribute: true
      },
      /**
       * Selected session to see details for.
       *
       * @attribute selectedSession
       * @type object
       * @default null
       */
      selectedSession: {
        value: null,
        notify: true
      },
      /**
       * The selected nav tab.
       *
       * @property selectedTab
       * @type string
       * @default 'live'
       */
      selectedTab: {
        type: String,
        value: 'live',
        notify: true,
        observer: 'selectedTabChanged'
      },
      /**
       * The selected video from the list of current live streaming videos.
       *
       * @property selectedVideoId
       * @type string
       * @default null
       */
      selectedVideoId: {
        value: null,
        notify: true,
        observer: 'selectedVideoIdChanged'
      },
      /**
       * The list of schedule sessions.
       *
       * @property sessions
       * @type array
       * @default []
       */
      sessions: {
        value: null,
        notify: true,
        observer: 'sessionsChanged'
      },
      /**
       * Social posts.
       *
       * @attribute socialPosts
       * @type array
       * @default []
       */
      socialPosts: {
        value: null,
        notify: true
      },
      /**
       * Speaker info.
       *
       * @property speakers
       * @type object
       * @default {}
       */
      speakers: {
        value: null,
        notify: true
      },
      /**
       * List of sessions happening today.
       *
       * @property todaysLiveSessions
       * @type array
       * @default []
       */
      todaysLiveSessions: {
        value: null,
        notify: true
      },
      /**
       * User's list of saved sessions.
       *
       * @attribute userSessions
       * @type array
       * @default []
       */
      userSessions: {
        value: null,
        notify: true
      }
    },
    created: function () {
      this.sessions = [];
      this.userSessions = [];
      this.socialPosts = [];
      this.speakers = {};
      this.liveStreamChannelIds = [];
      this.todaysLiveSessions = [];
      this.currentLiveSessions = [];
    },
    ready: function () {
      this.isiOS = IOWA.Util.isIOS();
      this._loadedOnDate = moment();
    },
    detached: function () {
      Polymer.dom(document.body).classList.remove('io-live-mode');
      if (this._refreshSessionTimeout) {
        clearTimeout(this._refreshSessionTimeout);
      }
    },
    selectedVideoIdChanged: function () {
      this.selectedVideoId = this.selectedVideoId.replace(/https?:\/\/youtu\.be\//, '');
    },
    dateChanged: function () {
      this.day1Start = moment(this.date);
      this.day1End = moment(this.day1Start).hours(17).startOf('hour');
      this.day2Start = moment(this.day1Start).add(1, 'days');
      this.day2End = moment(this.day2Start).hours(17).startOf('hour');
      // If we're before the start day of I/O, set current day to the start day
      // of I/O. Otherwise, set it to the current day of the show.
      var today = moment();
      if (today < this.day1Start) {
        this.mode = this._MODES.BEFORE;
      } else if (today > this.day2End) {
        this.mode = this._MODES.AFTER;
      } else {
        this.mode = this._MODES.LIVE;
      }
      // Calculate day view. Either 28 or 29 based on user's time, but normalize
      // it to PDT.
      var day1StartDayPDT = parseInt(moment(this.day1Start).tz('America/Los_Angeles').format('D'));
      var daysUntilStart = parseInt(moment(today).tz('America/Los_Angeles').format('D')) - day1StartDayPDT;
      this.currentDay = daysUntilStart <= 0 ? day1StartDayPDT : day1StartDayPDT + 1;
      // May 27 -> 1, May 28 -> 1, May 29 -> 2
      this.dayView = this.currentDay % day1StartDayPDT + 1;
      // Keynote ends at 12pm.
      this.afterKeynote = today.isAfter(moment(this.day1Start).add(2, 'hours').add(30, 'minutes'));
    },
    sessionsChanged: function () {
      if (!this.sessions.length) {
        return;
      }
      this.todaysLiveSessions = this.filterLiveSessionsByDay(this.sessions, this.currentDay);
    },
    openWidgetChanged: function () {
      Polymer.dom(this.$.livewidget).classList.toggle('open', this.openWidget);
      Polymer.dom(this.$.livewidget).classList.add('transitioning');
      // Make sure FAB closes in browsers that don't support the new CSS clip-path.
      if (IOWA.Util.isFF() || IOWA.Util.isIE() || IOWA.Util.isEdge()) {
        this.onFabTransition();
      }
    },
    modeChanged: function () {
      if (this.mode !== this._MODES.BEFORE) {
        Polymer.dom(document.body).classList.add('io-live-mode');
      }
      this.asyncFire('io-live-mode', { mode: this.mode });
    },
    autoOpenFabChanged: function () {
      // Expand FAB if we're in live mode and not streaming the keynote.
      if (this.autoOpenFab && this._videoReady && !this.duringKeynote && this.mode != this._MODES.BEFORE) {
        this.async(this.openFab, null, 600);
      }
    },
    selectedTabChanged: function () {
      IOWA.Analytics.trackEvent('live', 'tab select', this.selectedTab);
    },
    onVideoReady: function (e, detail, sender) {
      this._videoReady = true;
      this.autoOpenFabChanged();
      // go through auto-open fab flow.
      this.listLiveSessionsInThisHour();
    },
    onStateChange: function (e, detail) {
      var video = Polymer.dom(this.$.livecontainer).querySelector('google-youtube');
      switch (detail.data) {
      case YT.PlayerState.CUED:
        this.wasPaused_ = false;
        break;
      case YT.PlayerState.PAUSED:
        this.wasPaused_ = true;
        break;
      case YT.PlayerState.PLAYING:
        // this.updateVideoInfo();
        if (!this.wasPaused_) {
          IOWA.Analytics.trackEvent('live', 'channel select', this.selectedVideoId);
        }
        this.wasPaused_ = false;
        break;
      }
    },
    listLiveSessionsInThisHour: function () {
      // Refresh the page once a day if the user has the page open. This is
      // necessary to get new live streamed channel ids.
      var now = moment();
      if (this._refreshSessionTimeout && this._loadedOnDate.format('D') != now.format('D')) {
        location.reload();
        return;
      }
      this.currentLiveSessions = this.filterCurrentTimeBlock(this.todaysLiveSessions);
      // Find any live channels that are not streaming content right now and
      // include them in the list live streaming list for users to switch to.
      // The content will be recorded and/or other content.
      var liveIds = this.currentLiveSessions.map(function (session) {
        return session.youtubeUrl;
      });
      this.duringKeynote = this.currentLiveSessions.map(function (session) {
        return session.id;
      }).indexOf('__keynote__') !== -1;
      // If currently during the keynote, set it as the playing video and exit.
      if (this.duringKeynote) {
        this.selectedVideoId = this.currentLiveSessions[0].youtubeUrl;
        return;
      }
      // Keynote is guaranteed to be first channel. Ignore it as a channel since
      // we're handling it separately.
      var liveStreamChannelIds = this.liveStreamChannelIds.slice(1);
      this.missingChannels = liveStreamChannelIds.filter(function (channel) {
        return liveIds.indexOf(channel) < 0;
      }).map(function (channel) {
        return {
          label: liveStreamChannelIds.indexOf(channel) + 1,
          videoId: channel
        };
      }.bind(this));
      // If there are live streamed sessions happening this hour, start
      // playing the first one. Otherwise default to the first non-streaming
      // channel.
      if (this.currentLiveSessions.length) {
        this.selectedVideoId = this.currentLiveSessions[0].youtubeUrl;
      } else if (this.mode === this._MODES.AFTER || now.isBetween(this.day1End, this.day2Start)) {
        this.onPlayKeynote();
      } else {
        this.selectedVideoId = liveStreamChannelIds[0];
      }
      // Refresh live stream views when the next timeblock hits, either at the
      // next 30min mark or the next hour block.
      var nextTimeMark;
      var remainder = (30 - now.minute()) % 30;
      if (remainder > 0) {
        nextTimeMark = moment(now).add(remainder, 'minutes');
      } else {
        nextTimeMark = moment(now).add(1, 'hours').startOf('hour');
      }
      var timeout = nextTimeMark.diff(now, 'milliseconds');
      this._refreshSessionTimeout = setTimeout(this.listLiveSessionsInThisHour.bind(this), timeout);
    },
    openSession: function (e, detail, sender) {
      this.selectedSession = sender.templateInstance.model.session;
      // TODO: global pollution
      // Report session detail as pageview in GA. Should be the same as what
      // the schedule page reports as a deep link page view.
      var path = window.PREFIX + '/schedule#day' + this.dayView + '/' + this.selectedSession.id;
      IOWA.Analytics.trackPageView(path);
      this.$.sessiondetails.open();
    },
    onFabTransition: function (e, detail, sender) {
      e && e.stopPropagation();
      Polymer.dom(this.$.livewidget).classList.remove('transitioning');
      if (!this.openWidget) {
        this.set('$.schedfab.style.visibility', 'visible');
      }
    },
    onFabClick: function (e, detail, sender) {
      e.stopPropagation();
      this.openFab();
      IOWA.Analytics.trackEvent('live', 'fab opened', 'opened');
    },
    openFab: function () {
      this.set('$.schedfab.style.visibility', 'hidden');
      this.openWidget = true;
    },
    closeFab: function (e, detail, sender) {
      e && e.stopPropagation();
      this.openWidget = false;
      IOWA.Analytics.trackEvent('live', 'fab opened', 'closed');
    },
    onToggleSaveSession: function (e, detail, sender) {
      e.stopPropagation();
      var session = sender.templateInstance.model.session;
      if (session) {
        this.selectedSession = session;
      }
      var saved = !this.selectedSession.saved;
      IOWA.Schedule.saveSession(this.selectedSession.id, saved).then(function () {
        this.selectedSession.saved = saved;
        this.fetchingUserData = false;
        IOWA.Schedule.bookmarkSessionNotification(saved);
      }.bind(this)).catch(function (e) {
        this.fetchingUserData = false;
      }.bind(this));
    },
    onSessionDetailsOpen: function (e, detail, sender) {
      Polymer.dom(sender).querySelector('.session__title').focus();
    },
    onCountdownTimerThreshold: function (e, detail, sender) {
      if (detail.label === 'Ended' || detail.ended) {
        this.async(function () {
          Polymer.dom(this.$.livecontainer).querySelector('countdown-timer').style.opacity = 0;
        }, null, 1000);
      }
    },
    onCountdownFaded: function (e, detail, sender) {
      if (moment() > this.day1Start) {
        this.mode = this._MODES.LIVE;
      }
    },
    onPlayKeynote: function (e, detail, sender) {
      var keynoteSession = this.sessions[0];
      if (keynoteSession.id === '__keynote__') {
        this.selectedVideoId = keynoteSession.youtubeUrl;
        IOWA.Analytics.trackEvent('live', 'play keynote video');
      }
    },
    speakerIdsToNameString: function (speakers) {
      if (!speakers) {
        return '';
      }
      return speakers.map(function (speakerId) {
        return this.speakers[speakerId].name;
      }.bind(this)).join(', ');
    },
    filterLiveSessionsByDay: function (sessions, day) {
      return sessions.filter(function (session) {
        return session.day === day && session.isLivestream;
      });
    },
    filterHappenedSessions: function (sessions) {
      var now = moment();
      return sessions.filter(function (session) {
        var sessionStart = moment(session.startTimestamp);
        var sessionEnd = moment(session.endTimestamp);
        var isInTheFuture = sessionStart > now;
        var isHappeningNow = sessionStart < now && now < sessionEnd;
        return isInTheFuture || isHappeningNow;
      });
    },
    filterCurrentTimeBlock: function (sessions) {
      var now = moment();
      return sessions.filter(function (session) {
        // Only keep session that fall under the current hour e.g. filter out
        // sessions that have already happened or ones in a future hour block.
        var sessionStart = moment(session.startTimestamp);
        var sessionEnd = moment(session.endTimestamp);
        return sessionStart < now && now < sessionEnd;
      });
    },
    selectScheduleTab: function (e, detail, sender) {
      e.preventDefault();
      this.selectedTab = 'schedule';
    },
    generateSpeakerImage: function (session) {
      var idx = Math.floor(Math.random() * session.speakers.length);
      return this.speakers[session.speakers[idx]].thumbnailUrl || 'images/schedule/profile_placeholder.png';
    },
    _computeIf: function (_MODES, mode) {
      return mode === _MODES.BEFORE;
    },
    _computeSrc: function (selectedSession) {
      return selectedSession.photoUrl || 'images/schedule/session_placeholder.jpg';
    },
    _computeIcon: function (selectedSession) {
      return selectedSession.saved ? 'check' : 'add';
    },
    _computeClass: function (selectedSession) {
      return this.tokenList({ active: selectedSession.saved });
    },
    _computeIf2: function (_MODES, mode) {
      return mode === _MODES.AFTER;
    },
    _computeIf3: function (_MODES, currentLiveSessions, mode) {
      return mode === _MODES.LIVE && !currentLiveSessions.length;
    },
    _computeHref: function (dayView) {
      return 'schedule#day' + dayView;
    },
    _computeHref2: function () {
      return 'schedule#myschedule';
    },
    _computeIf4: function (_MODES, mode) {
      return mode !== _MODES.BEFORE;
    },
    _compute_src: function (speakerId, speakers) {
      return speakers[speakerId].thumbnailUrl || 'images/schedule/profile_placeholder.png';
    },
    _computeHref3: function (speakerId, speakers) {
      return speakers[speakerId].plusoneUrl;
    },
    _computeHidden: function (speakerId, speakers) {
      return !speakers[speakerId].plusoneUrl;
    },
    _computeHref4: function (speakerId, speakers) {
      return speakers[speakerId].twitterUrl;
    },
    _computeHidden2: function (speakerId, speakers) {
      return !speakers[speakerId].twitterUrl;
    },
    _computeIcon2: function (selectedVideoId, session) {
      return selectedVideoId === session.youtubeUrl ? 'io:play-circle-fill' : 'io:play-circle-outline';
    },
    _computeSrc2: function (channel) {
      return 'images/schedule/channel' + channel.label + '.png';
    },
    _computeTitle: function (channel) {
      return 'Channel ' + channel.label;
    },
    _computeIcon3: function (channel, selectedVideoId) {
      return selectedVideoId === channel.videoId ? 'io:play-circle-fill' : 'io:play-circle-outline';
    },
    _computeId: function (session) {
      return 'session-' + session.id + '-title';
    },
    _computeExpression3: function (speakerId, speakers) {
      return speakers[speakerId].name;
    },
    _computeExpression4: function (speakerId, speakers) {
      return speakers[speakerId].company;
    },
    _computeExpression5: function (speakerId, speakers) {
      return speakers[speakerId].bio;
    },
    tokenList: function (obj) {
      var pieces = [];
      for (var key in obj) {
        if (obj[key]) {
          pieces.push(key);
        }
      }
      return pieces.join(' ');
    }
  });
</script>
</dom-module>
