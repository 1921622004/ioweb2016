<!--
Copyright 2016 Google Inc. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at
  http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/google-youtube/google-youtube.html">

<link rel="import" href="io-gallery.html">
<link rel="import" href="shared-app-styles.html">
<link rel="import" href="PageBehavior.html">

<dom-module id="io-about-page">
<template>
  <style include="shared-app-styles">
    :host {
      display: block;
    }

    :host {
      --color-cyan-500: #00BCD4; /* Duplicated from _colors.scss */
    }

    .card__photo iron-image {
      --iron-image-placeholder: {
        background-color: var(--color-cyan-500);
        background-size: contain !important;
      };
    }

    .pics__section iron-image {
      --iron-image-placeholder: {
        background-size: 15% !important;
      };
    }
  </style>

  <div class="masthead-container" layout horizontal end>
    <div class="masthead-meta">
      <h1>About</h1>
    </div>
  </div>

  <paper-toolbar class="navbar__overlay navbar__overlay--gallery"
                 aria-hidden$="{{!photoGalleryActive}}" fit>
    <paper-icon-button icon="arrow-back" on-tap="closePhotoGallery"
                       aria-label="Close gallery"
                       tabindex$="[[_enableTabIndex(photoGalleryActive)]]"></paper-icon-button>
    <span flex><i18n-msg msgid="io-in-photos">I/O in Photos</i18n-msg></span>
  </paper-toolbar>

  <paper-toolbar class="navbar__overlay navbar__overlay--video"
                 aria-hidden$="{{!app.fullscreenVideoActive}}" fit>
    <paper-icon-button icon="arrow-back" on-tap="closeVideoCard"
                       aria-label="Close video"
                       tabindex$="[[_enableTabIndex(app.fullscreenVideoActive)]]"></paper-icon-button>
    <span flex><i18n-msg msgid="watch-keynote-video">Watch the 2015 I/O Keynote</i18n-msg></span>
  </paper-toolbar>

  <io-gallery id="gallery" hidden$="{{!photoGalleryActive}}" mobile="{{app.isPhoneSize}}"
              image-path="media.image.url" active="{{photoGalleryActive}}" fit></io-gallery>

  <div class="active">
    <div class="card__container slide-up">
      <div class="card">
        <div class="card-content">
          <h3>Google I/O is an annual developer conference with inspirational talks, hands-on learning, and a chance to hear more about Google's latest developer products.</h3>
        </div>
        <div class="card-content">
          <span class="anchor-like" role="link" tabindex="0"
              data-track-link="about-view-photos-card"
              on-tap="togglePhotoGallery">See photos from I/O 2015</span>
        </div>
      </div>
    </div>

    <div class="slide-up-delay">

      <section class="page__section pics__section" layout vertical>
        <div layout horizontal>
          <div class="photo__about" flex two$="{{app.isDesktopSize}}" relative>
            <iron-image placeholder="images/home/io-logo@2x.png"
                        style="background-color:#00BCD4"
                        sizing="cover" preload fade fit></iron-image>
          </div>
          <div layout vertical flex>
            <div class="photo__about--top" flex relative>
              <iron-image placeholder="images/home/io-logo@2x.png"
                          style="background-color:#00ACC1"
                          sizing="cover" preload fade fit></iron-image>
            </div>
            <div class="photo__about--bottom" flex relative hidden$="{{app.isPhoneSize}}">
              <iron-image placeholder="images/home/io-logo@2x.png"
                          style="background-color: #B2EBF2"
                          sizing="cover" preload fade fit></iron-image>
            </div>
          </div>
        </div>
      </section>

      <div class="card__container sidebyside card--force-compositing"
           layout horizontal vertical$="{{app.isPhoneSize}}">
        <div class="card" auto-vertical flex>
          <div class="card-content">
            <h3>Learn about product and platform innovations at Google, starting with the keynote hosted by our Senior Vice-President of Products, Sundar Pichai.</h3>
          </div>
          <div class="card-content">
            <a href="videos" data-track-link="about-see-keynote-and-sessions">Watch the 2015 keynote and sessions
            </a>
          </div>
        </div>
        <div class="card" layout vertical auto-vertical flex
             on-tap="playVideo" data-track-link="about-watch-keynote-video">
          <div flex class="card__photo card__photo--recap"></div>
          <div class="card-content">
            <img src="/io2016/images/play-video-button-grey.png"
                 class="play__button play__button--card" alt="Play video">
            <span class="anchor-like" role="link" tabindex="0">Watch the keynote</span>
          </div>
        </div>
      </div>

      <section id="hashtag" class="page__section bg-cyan">
        <a href="//www.google.com/?#q=%23io15" target="_blank" data-track-link="about-hashtag-search"><div class="io__hash"></div></a>
      </section>

    </div>
  </div>

  <template is="dom-if" if="[[app.fullscreenVideoActive]]" restamp>
    <div class="fullvideo__container" fit hidden>
      <img src="/io2016/images/home/keynote2015.jpg"
           class="fullvideo_thumbnail"
           alt="Watch the I/O 2015 keynote" fit>
      <google-youtube video-id="7V-fIGMDsmE" height="100%" width="100%" fit
                      autohide="1" controls="2" modestbranding="1" showinfo="0"
                      iv_load_policy="3" rel="0" autoplay="1"></google-youtube>
    </div>
  </template>

</template>
<script>
(function() {
  'use strict';

  Polymer({
    is: 'io-about-page',

    behaviors: [IOBehaviors.PageBehavior],

    properties: {
      /*
       * True if the photo gallery overlay is active.
       */
      photoGalleryActive: {
        type: Boolean,
        value: false
      }
    },

    title: 'About',
    name: 'about',

    attached: function() {
      // Reset state for when revisiting the page.
      this.set('app.fullscreenVideoActive', false);
      this.photoGalleryActive = false;
    },

    onPageTransitionDone: function(e) {
      // TODO: consider calling this periodically while the page is open.
      // Don't want to be rate limited though :\
      var setImages = function(photos) {
        var images = Array.prototype.slice.call(
            Polymer.dom(this.root).querySelectorAll('.pics__section iron-image'));

        var usedImages = [];

        var update = function(images) {
          var image = images.pop();
          if (image) {
            setTimeout(function() {
              // Get a refresh image index every time.
              var idx;
              do {
                idx = Math.floor(Math.random() * photos.length);
              } while (usedImages.indexOf(idx) != -1);

              usedImages.push(idx);

              image.src = photos[idx].media.image.url;

              update(images);
            }, 300);
          }
        };

        update(images);
      }.bind(this);

      if (this.$.gallery.items.length) {
        setImages(this.$.gallery.items);
      } else {
        IOWA.Picasa.fetchPhotos(0, function(photos) {
          this.$.gallery.items = photos;
          setImages(photos);
        }.bind(this));
      }

      if (location.hash.substring(1) == 'photos') {
        this.togglePhotoGallery(e);
      }
    },

    closePhotoGallery: function(e, detail) {
      this.runPhotoGalleryAnimation(true, function() {
        this.photoGalleryActive = false;
      }.bind(this));
      history.replaceState({}, null, location.pathname); // Remove #photos hash from URL.
    },

    playVideo: function(e, detail) {
      this.currentCard = Polymer.dom(e).rootTarget;
      this.set('app.fullscreenVideoActive', true); // Active the placeholder template.

      IOWA.Analytics.trackEvent('link', 'click',
          this.currentCard.getAttribute(this.app.ANALYTICS_LINK_ATTR));

      // Wait one rAF for template to have stamped.
      this.async(function() {
        this.cardVideoTakeover(this.currentCard);
      });
    },

    togglePhotoGallery: function(e, detail) {
      var target = Polymer.dom(e).rootTarget;

      if (target && target.hasAttribute(this.app.ANALYTICS_LINK_ATTR)) {
        IOWA.Analytics.trackEvent(
            'link', 'click', target.getAttribute(this.app.ANALYTICS_LINK_ATTR));
      } else {
        IOWA.Analytics.trackEvent('link', 'click', 'about-photos-deeplink');
      }

      if (!this.photoGalleryActive) {
        // Smooth to gallery section.
        // var destEl = IOWA.Elements.Main.querySelector('.pics__section');
        // IOWA.Util.smoothScroll(destEl, 400);

        var galleryReady = function() {
          this.photoGalleryActive = true;
          this.runPhotoGalleryAnimation();
        }.bind(this);

        // Use cached photos.
        if (this.$.gallery.items.length) {
          galleryReady();
        } else {
          IOWA.Picasa.fetchPhotos(0, function(photos) {
            this.$.gallery.items = photos;
            galleryReady();
          }.bind(this));
        }

      } else {
        this.runPhotoGalleryAnimation(true); // reverse animation when gallery is open.
        this.photoGalleryActive = false;
      }
    },

    runPhotoGalleryAnimation: function(opt_reverse, opt_callback) {
      var root = Polymer.dom(this.root);
      var topCard = root.querySelector('.card__container.slide-up');
      var bottomCard = root.querySelector('.pics__section').nextElementSibling;
      var bottomSection = root.querySelector('#hashtag');

      var navOverlay = document.querySelector('.navbar__overlay--gallery');

      var reverse = opt_reverse || false;

      var ANIMATION_DURATION = 500;

      var animationTiming = {
        duration: ANIMATION_DURATION,
        fill: 'forwards',
        direction: reverse ? 'reverse' : 'normal',
        easing: 'cubic-bezier(0.4,0,0.2,1)'
      };

      var animation = new KeyframeEffect(bottomSection, [
        {transform: 'translateY(0)', opacity: 1},
        {transform: 'translateY(100px)', opacity: 0}
      ], animationTiming);

      // Only animate top/bottom cards offscreen if not on mobile.
      if (!this.$.gallery.mobile) {
        animation = new GroupEffect([
          animation,
          new KeyframeEffect(topCard, [
            {transform: 'translateY(0)', opacity: 1},
            {transform: 'translateY(-100px)', opacity: 0}
          ], animationTiming),
          new KeyframeEffect(bottomCard, [
            {transform: 'translateY(0)', opacity: 1},
            {transform: 'translateY(100px)', opacity: 0}
          ], animationTiming)
        ]);
      }

      var galleryAnimation = new KeyframeEffect(this.$.gallery, [
        {opacity: 0}, {opacity: 1}
      ], animationTiming);

      if (reverse) {
        // Fade out gallery and slide back in page sections at the same time.
        IOWA.PageAnimation.play(new GroupEffect([
          animation, galleryAnimation
        ]), opt_callback);
        navOverlay.classList.remove('active');
      } else {
        // Slide out page sections, then fade in gallery.
        IOWA.PageAnimation.play(new SequenceEffect([
          animation, galleryAnimation
        ]), opt_callback);
        navOverlay.classList.add('active');
      }
    }

  });

}());
</script>
</dom-module>
