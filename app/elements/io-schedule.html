<!--
Copyright 2016 Google Inc. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at
  http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">

<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">

<link rel="import" href="../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">

<link rel="import" href="../bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="../bower_components/paper-radio-button/paper-radio-button.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">

<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../bower_components/iron-dropdown/iron-dropdown-scroll-manager.html">
<link rel="import" href="../bower_components/neon-animation/animations/scale-up-animation.html">
<link rel="import" href="../bower_components/neon-animation/animations/fade-out-animation.html">

<link rel="import" href="../bower_components/google-youtube/google-youtube.html">

<link rel="import" href="UtilBehavior.html">
<link rel="import" href="shared-app-styles.html">


<dom-module id="io-session-details">
<link rel="import" type="css" href="io-session-details.css">
<template>
  <style include="shared-app-styles"></style>

  <!-- <paper-dialog id="sessionDetails"
                no-cancel-on-outside-click
                no-cancel-on-esc-key
                restore-focus-on-close
                no-auto-focus
                entry-animation="scale-up-animation"
                exit-animation="fade-out-animation"
                on-iron-overlay-closed="_onSessionDetailsClose"
                on-iron-overlay-opened="_onSessionDetailsOpen"> -->
  <paper-dialog id="sessionDetails"
                restore-focus-on-close
                with-backdrop$="[[!app.isIOS]]"
                entry-animation="scale-up-animation"
                exit-animation="fade-out-animation"
                on-iron-overlay-closed="_onSessionDetailsClose"
                on-iron-overlay-opened="_onSessionDetailsOpen">

    <!-- <div class="scrollable"> -->
      <div class="fullschedule-banner card-content bg-bluegrey-50-60"
           layout horizontal center>
        <paper-icon-button icon="io:arrow-back" dialog-dismiss
                           aria-label="Full Schedule"></paper-icon-button>
        <span>Full Schedule</span>
      </div>

      <paper-dialog-scrollable>

      <!-- <div class="session_details_wrapper bg-bluegrey-50-20"> -->
      <div class="bg-bluegrey-50-20">

        <div class="card__photo" relative>

          <template is="dom-if" if="[[sessionHasVideo(_startScheduleVideo, selectedSession.isLivestream, selectedSession.youtubeUrl)]]" restamp>
            <google-youtube
                video-id="[[_toVideoIdFilter(selectedSession.youtubeUrl)]]"
                height="100%" width="100%" fit
                autohide="1" controls="2" modestbranding="1" showinfo="0"
                iv_load_policy="3" rel="0" autoplay="1"
                on-google-youtube-ready="onScheduleVideoReady"></google-youtube>
          </template>
          <div class="play__button__container" on-click="onVideoPlay"
               data-track-link$="{{selectedSession.youtubeUrl}}"
               hidden$="{{showSessionPlayButton(selectedSession)}}"
               layout vertical center-center fit>
            <h4>Watch video</h4>
          </div>
          <iron-image src="[[placeholderImage(selectedSession)]]"
                      placeholder="images/io16-social.jpg"
                      sizing="cover" preload fade fit></iron-image>
          <paper-fab icon="[[_computeSessionSavedIcon(selectedSession.saved)]]"
                     mini="[[app.isPhoneSize]]"
                     class$="[[_addClass('active', selectedSession.saved)]]"
                     on-up="_onToggleSaveSession"></paper-fab>
        </div>
        <div class="session__info__section session__details">
          <h3 class="session__title" tabindex="-1">{{selectedSession.title}}</h3>
          <h5 class="session__time">May <span>{{selectedSession.day}}</span> / <span>{{selectedSession.start}}</span><span hidden$="{{_equal('__keynote__', selectedSession.id)}}"> - {{selectedSession.end}}</span> / <span>{{selectedSession.room}}</span></h5>
          <div class="session__desc">{{selectedSession.description}}</div>
          <div class="session__categories">
            <div class="session__livestream" hidden$="{{!selectedSession.isLivestream}}">
              <iron-icon icon="io:videocam"></iron-icon>
              <a href="/io2016/schedule?filters=Live%20Streamed"
                 data-track-link="schedule-details-filter"
                 on-click="_onApplyFilter">Live streamed</a>
            </div>
            <template is="dom-if" if="[[tags.length]]">
              <div class="session__tags">
                <iron-icon icon="io:filter-list" aria-label="Filter sessions"></iron-icon>
                <template is="dom-repeat" items="[[tags]]" as="tag">
                  <a href$="/io2016/schedule?filters=[[tag]]"
                     data-track-link="schedule-details-filter"
                     on-click="_onApplyFilter">[[tag]]</a>
                </template>
              </div>
            </template>
          </div>

          <paper-menu-button class="session__social"
                             on-iron-activate="openShareWindow"
                             on-iron-overlay-closed="noop">
            <paper-button class="dropdown-trigger" raised>Share</paper-button>
            <paper-listbox class="dropdown-content" layout vertical>
              <paper-item data-share-type="gplus"
                          data-track-link="schedule-share-gplus">
                <iron-icon icon="io:post-gplus" class="share-icon"></iron-icon> Google
              </paper-item>
              <paper-item data-share-type="twitter"
                          data-track-link="schedule-share-twitter">
                <iron-icon icon="io:post-twitter" class="share-icon"></iron-icon> Twitter
              </paper-item>
              <paper-item data-share-type="fb"
                          data-track-link="schedule-share-fb">
                <iron-icon icon="io:post-facebook" class="share-icon"></iron-icon> Facebook
              </paper-item>
            </paper-listbox>
          </paper-menu-button>

        </div>

        <div class="session__info__section session__speakers"
             hidden$="{{!selectedSession.speakers.length}}">
          <span>Speakers</span>
          <div layout horizontal justified wrap>
            <template is="dom-repeat" items="[[selectedSession.speakers]]" as="speakerId">
              <div class="speaker__card">
                <div layout horizontal>
                  <div>
                    <img src$="[[speakerProfilePic(app.scheduleData.speakers, speakerId)]]"
                         class="profilepic">
                  </div>
                  <div>
                    <div class="speaker__name">{{_propOfArrayItem(app.scheduleData.speakers, speakerId, 'name')}}</div>
                    <div class="speaker__title">{{_propOfArrayItem(app.scheduleData.speakers, speakerId, 'company')}}</div>
                  </div>
                </div>
                <div class="speaker__info" >
                  <div class="speaker__desc">{{_propOfArrayItem(app.scheduleData.speakers, speakerId, 'bio')}}</div>
                  <div class="session__social" layout horizontal center>
                    <a href$="{{_propOfArrayItem(app.scheduleData.speakers, speakerId, 'plusoneUrl')}}" target="_blank" class="share-icon" hidden$="{{!_propOfArrayItem(app.scheduleData.speakers, speakerId, 'plusoneUrl')}}"><iron-icon icon="io:post-gplus"></iron-icon></a>
                    <a href$="{{_propOfArrayItem(app.scheduleData.speakers, speakerId, 'twitterUrl')}}" target="_blank" class="share-icon" hidden$="{{!_propOfArrayItem(app.scheduleData.speakers, speakerId, 'twitterUrl')}}"><iron-icon icon="io:post-twitter" class="twitter-icon"></iron-icon></a>
                  </div>
                </div>
              </div>
            </template>

          </div>
        </div>

        <!-- <div class="session__info__section session__info__links card-content"
            layout horizontal justified$="{{app.isPhoneSize}}"
            hidden$="{{_computeHideSessionInfo(selectedSession)}}">
          <span class="anchor-like" role="link"
                on-click="onRelatedContent"
                data-track-link="schedule-detail-related"
                hidden$="{{!selectedSession.hasRelated}}"
                dialog-dismiss>View related content</span>
          <span class="anchor-like" role="link"
              on-click="onRateSession"
              data-track-link="schedule-rate-session"
              hidden$="{{_computeHideSessionRating(selectedSession)}}">Rate session</span>
          <span class="anchor-like-disabled" hidden$="{{!selectedSession.rated}}">Rating submitted</span>
        </div> -->
      </div>

      </paper-dialog-scrollable>
    <!-- </div>  --><!-- .scrollable -->
  </paper-dialog>

</template>
<script>
(function() {
  // Flag to not double-record page view on deep linking into session.
  var pageIsDeepLinked_ = false;

  Polymer({
    is: 'io-session-details',

    behaviors: [IOBehaviors.UtilBehavior],

    properties: {
      /**
       * IO session object to display details for.
       */
      selectedSession: {
        type: Object,
        value: null,
        notify: true,
        observer: '_selectedSessionChanged'
      },

      tags: {
        type: Array,
        computed: '_computeTagList(selectedSession.tags)'
      },

      _startScheduleVideo: {
        type: Boolean,
        value: false
      }
    },

    _selectedSessionChanged: function() {
      if (this.selectedSession) {
        this.$.sessionDetails.open();
        Polymer.IronDropdownScrollManager.pushScrollLock(this);
      } else {
        this.$.sessionDetails.close();
        Polymer.IronDropdownScrollManager.removeScrollLock(this);
      }
    },

    onScheduleVideoReady: function(e, detail) {
      this.$.sessionDetails.querySelector('iron-image').classList.add('fadeout');
      this.$.sessionDetails.querySelector('.play__button__container').classList.add('fadeout');
    },

    onVideoPlay: function(e, detail) {
      e.stopPropagation();
      e.preventDefault();

      this._startScheduleVideo = true;

      var target = Polymer.dom(e).rootTarget;
      if (target.hasAttribute(this.app.ANALYTICS_LINK_ATTR)) {
        var videoUrl = target.getAttribute(this.app.ANALYTICS_LINK_ATTR);
        IOWA.Analytics.trackEvent('schedule', 'video play', videoUrl);
        IOWA.IOFirebase.markVideoAsViewed(videoUrl);
      }
    },

    sessionHasVideo: function(startVideo, isLivestream, youtubeUrl) {
      return startVideo && !isLivestream && youtubeUrl;
    },

    showSessionPlayButton: function(selectedSession) {
      if (!selectedSession) {
        return false;
      }
      return selectedSession.isLivestream || !selectedSession.youtubeUrl;
    },

    placeholderImage: function(selectedSession) {
      if (selectedSession && selectedSession.photoUrl) {
        return selectedSession.photoUrl;
      }
      return 'images/schedule/session_placeholder.jpg';
    },

    speakerProfilePic: function(speakers, id) {
      if (speakers && speakers[id].thumbnailUrl) {
        return speakers[id].thumbnailUrl;
      }
      return 'images/schedule/profile_placeholder.png';
    },

    _computeHideSessionInfo: function(session) {
      if (session === null) {
        return false;
      }
      var isFinished = new Date(session.endTimestamp) < Date.now();
      return session.id === '__afterhours__' ||
             (!isFinished && !session.hasRelated);
    },

    _computeHideSessionRating: function(session) {
      if (session === null) {
        return false;
      }
      var isFinished = new Date(session.endTimestamp) < Date.now();
      return session.rated || session.id == '__afterhours__' || !isFinished;
    },

    _computeSessionSavedIcon: function(saved) {
      return saved ? 'io:check' : 'io:add';
    },

    _computeTagList: function(tagList) {
      if (!tagList) {
        return [];
      }
      var tags = this.app.scheduleData.tags;
      var list = tagList.map(function(tag) {
        return tags[tag] ? tags[tag].name : '';
      }).filter(function(tag) {
        return tag.length;
      });
      return list;
    },

    _onToggleSaveSession: function(e) {
      var saved = !this.selectedSession.saved;
      this.fire('session-bookmark', {
        session: this.selectedSession,
        saved: saved
      });
    },

    _onSessionDetailsClose: function(e) {
      // Remove session id hash from URL.
      var search = IOWA.Util.removeSearchParam(window.location.search, 'sid');
      var selectedSubpage = IOWA.Router.parseUrl(window.location.href).subpage;
      var url = IOWA.Router.composeUrl('schedule', selectedSubpage, '', search);
      history.replaceState({}, null, url);

      document.title = 'Schedule';
      pageIsDeepLinked_ = false;

      // Reset video state.
      var video = this.$.sessionDetails.querySelector('google-youtube')
      if (video) {
        video.pause();
      }
      this.$.sessionDetails.querySelector('iron-image').classList.remove('fadeout');
      this.$.sessionDetails.querySelector('.play__button__container').classList.remove('fadeout');
      this._startScheduleVideo = false;

      this.selectedSession = null;
    },

    _onSessionDetailsOpen: function() {
      // TODO dialog supports autofocus attr.
      //this.$.sessionDetails.querySelector('.session__title').focus();

      document.title = this.selectedSession.title + ' - Google I/O Schedule';

      // Update URL with deep link. Always ensure sid parameter is set.
      var sessionId = this.selectedSession.id;

      var search = IOWA.Util.setSearchParam(location.search, 'sid', sessionId);
      var selectedSubpage = IOWA.Router.parseUrl(window.location.href).subpage;

      var url = IOWA.Router.composeUrl('schedule', selectedSubpage,
                                       sessionId, search);
      history.pushState({}, null, url);

      // Report session detail as pageview in GA, only if we're not loading
      // the page from a session detail deep link. Don't want to double record.
      if (!pageIsDeepLinked_) {
        IOWA.Analytics.trackPageView(location.pathname + location.hash);
      }
    },

    _onApplyFilter: function(e) {
      e.preventDefault();
      e.stopPropagation();

      var target = Polymer.dom(e).rootTarget;
      if (target && target.hasAttribute(this.app.ANALYTICS_LINK_ATTR)) {
        IOWA.Analytics.trackEvent('link', 'click',
            target.getAttribute(this.app.ANALYTICS_LINK_ATTR));
      }

      var tag = target.textContent;
      if (e.model) {
        tag = e.model.tag;
      }

      this.fire('apply-filter', {tag: tag});
    },

    onRelatedContent: function(e, detail) {
      e.stopPropagation();

      var target = Polymer.dom(e).rootTarget;

      if (target && target.hasAttribute(this.app.ANALYTICS_LINK_ATTR)) {
        IOWA.Analytics.trackEvent('link', 'click',
            target.getAttribute(this.app.ANALYTICS_LINK_ATTR));
      }
      this.filters = [this.selectedSession.id];
    },

    onRateSession: function(e, detail) {
      var target = Polymer.dom(e).rootTarget;

      if (target && target.hasAttribute(this.app.ANALYTICS_LINK_ATTR)) {
        IOWA.Analytics.trackEvent('link', 'click',
            target.getAttribute(this.app.ANALYTICS_LINK_ATTR));
      }
      this.answers = {}; // Reset answers.
      this.$.ratePanel.open();
    },

    onRateSessionSubmit: function(e, detail) {
      var target = Polymer.dom(e).rootTarget;

      if (target.hasAttribute('disabled')) {
        return;
      }
      IOWA.Schedule.saveSurvey(this.selectedSession.id, this.answers).then(function() {
        this.set('selectedSession.rated', true);
      }.bind(this));
    },

    openShareWindow: function(e, detail) {
      e.preventDefault();
      e.stopPropagation();

      var type = detail.item.getAttribute('data-share-type');
      var url = null;
      var width = 600;
      var height = 600;
      var winOptions = 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=' +
                       height + ',width=' + width;

      var title = this.selectedSession ?
                  this.selectedSession.title : document.title;

      // Shorten current URL so it's ready to go.
      IOWA.Util.shortenURL(location.href).then(function(shortURL) {
        switch (type) {
          case 'fb':
            height = 229;
            url = 'https://www.facebook.com/sharer.php?u=' +
                  encodeURIComponent(shortURL) +
                  '&t=' + encodeURIComponent(title);

            break;
          case 'gplus':
            height = 348;
            width = 512;
            url = 'https://plus.google.com/share?url=' +
                  encodeURIComponent(shortURL) +
                  '&hl=' + encodeURIComponent(document.documentElement.lang);
            break;
          case 'twitter':
            height = 253;

            var text = '#io16 brings together devs to explore the next ' +
                       'generation of tech and mobile. Join us online or in ' +
                       'person May 18-20: https://google.com/io';

            if (this.selectedSession) {
              text = 'Check out "' + title + '" at #io16: ' + shortURL;
            }

            url = 'https://twitter.com/intent/tweet?text=' +
                   encodeURIComponent(text);

            break;
          default:
            return;
        }

        window.open(url, 'share', winOptions);
      }.bind(this));
    },

    noop: function(e) {
      e.preventDefault();
      e.stopPropagation();
    }

  });
}());
</script>
</dom-module>

<dom-module id="io-schedule-row">
<link rel="import" type="css" href="io-schedule.css">
<template>
  <style include="shared-app-styles">
    :host {
      display: block;
    }
  </style>
  <div layout horizontal
       class$="[[_addClass('session-block', session.firstOfBlock)]]">
    <div class="schedule-block-title">
      <h1 layout horizontal end>
        <span>[[_getMeridiemPart(session.block, 0)]]</span>
        <span class="schedule-block-meridiem">[[_getMeridiemLetter(session.block)]]</span>
      </h1>
    </div>
    <div class$="schedule-row [[_addClass('saved', session.saved)]]"
         layout horizontal center
         on-keyup="onSessionKeyUp">
      <a href$="schedule?sid={{session.id}}"
         id="session-{{session.id}}-time"
         class="schedule-title"
         on-click="onSessionSelect"
         title$="{{session.title}}" flex>
        <div>[[session.title]]</div>
        <div id="session-{{session.id}}-time" class="schedule-time" layout horizontal center>
          <div>
            <span>[[session.start]]</span>
            <span hidden$="{{_sessionIs(session, '__keynote__')}}"> - [[session.end]]</span> /
            <span>[[session.room]]</span>
          </div>
          <iron-icon icon="io:videocam" class="schedule-livestream"
                     hidden$="[[!session.isLivestream]]"></iron-icon>
        </div>
      </a>

      <div class="schedule-toggle-buttons">
        <iron-icon icon="io:add-circle"
                   class="schedule-add-button"
                   on-click="onAddSession"></iron-icon>
        <iron-icon icon="io:remove-circle"
                   class="schedule-remove-button"
                   on-click="onRemoveSession"></iron-icon>
      </div>

      <div class="schedule-toggle-buttons-mobile">
        <iron-icon icon="io:add-circle-outline"
                   class="schedule-add-button"
                   on-click="onAddSession"></iron-icon>
        <iron-icon icon="io:remove-circle-outline"
                   class="schedule-remove-button"
                   on-click="onRemoveSession"></iron-icon>
      </div>

    </div>

  </div>
</template>
<script>
(function() {
  Polymer({
    is: 'io-schedule-row',

    behaviors: [IOBehaviors.UtilBehavior],

    properties: {
      /**
       * IO session object.
       */
      session: {
        type: Object,
        value: function() { return {}; }
      }
    },

    onSessionSelect: function(e, detail) {
      e.preventDefault();
      e.stopPropagation();
      this.selectSession(this.session);
    },

    selectSession: function(session) {
      this.fire('session-select', {session: session});
    },

    onAddSession: function(e) {
      e.stopPropagation();
      this.fire('session-bookmark', {
        session: this.session,
        saved: true
      });
    },

    onRemoveSession: function(e) {
      e.stopPropagation();
      this.fire('session-bookmark', {
        session: this.session,
        saved: false
      });
    },

    onSessionKeyUp: function(e, detail) {
      // enter or ctrl+alt+space (voice over click)
      if (e.keyCode === 13 || e.altKey && e.ctrlKey && e.keyCode === 32) {
        this.selectSession(this.session);
      }
    },

    _sessionIs: function(session, targetSession) {
      return session.id === targetSession;
    },

    _getMeridiemPart: function(str, part) {
      return str.split(' ')[part];
    },

    _getMeridiemLetter: function(sessionBlock) {
      return this._getMeridiemPart(sessionBlock, 1)[0];
    }

  });
}());
</script>
</dom-module>

<!--
The `<io-schedule>` element renders a schedule for a given day(s).
-->
<!--
Fired when session is selected.

@event session-select
@param {Object} detail
@param {Object} detail.session The selected session.
-->
<!--
Fired when the user toggles bookmarking/removing a session.

@event session-bookmark
@param {Object} detail
@param {Object} detail.session The session.
@param {Object} detail.save True if the session is being saved.
-->
<dom-module id="io-schedule">
  <link rel="import" type="css" href="io-schedule.css">
  <template>
    <style include="shared-app-styles">
      :host {
        display: block;
      }
      paper-radio-button, paper-checkbox {
        --primary-text-color: inherit;
      }
    </style>

    <div hidden$="[[!showFilters]]" relative>
      <div id="filters" class="card-content bg-bluegrey-50-40" layout horizontal justified>
        <div class="filter-section">
          <h4>Tracks</h4>
          <paper-radio-group allow-empty-selection
                             on-paper-radio-group-changed="onApplyFilter"
                             on-iron-deselect="onApplyFilter">
            <template is="dom-repeat" items="[[sessionThemes]]" as="theme">
              <paper-radio-button name="[[theme]]">[[theme]]</paper-radio-button>
            </template>
          </paper-radio-group>
        </div>
        <div class="filter-section">
          <h4>Types</h4>
          <paper-checkbox id="liveStreamFilter" name="Live streamed"
              on-tap="onLiveSessionsFilters">Live streamed</paper-checkbox>
          <paper-radio-group allow-empty-selection
                             on-paper-radio-group-changed="onApplyFilter"
                             on-iron-deselect="onApplyFilter">
            <template is="dom-repeat" items="[[sessionTypes]]" as="type">
              <paper-radio-button name="[[type]]">[[type]]</paper-radio-button>
            </template>
          </paper-radio-group>
        </div>
        <div class="filter-section filter-section--types" relative>
          <h4>Tracks</h4>
          <a href="#" class="filter-section--clearall" on-click="clearFilters">Clear all</a>
          <paper-radio-group allow-empty-selection
                             on-paper-radio-group-changed="onApplyFilter"
                             on-iron-deselect="onApplyFilter">
            <template is="dom-repeat" items="[[sessionTopics]]" as="track">
              <paper-radio-button name="[[track]]">[[track]]</paper-radio-button>
            </template>
          </paper-radio-group>
        </div>
      </div>
    </div>

    <div class="card-content filters-banner bg-bluegrey-50-60"
         hidden$="[[!filters.length]]" layout horizontal center justified>
      <span>filtering by [[_prettifyFilters(filters.*)]]</span>
      <span layout horizontal center on-click="clearFilters">
        clear <iron-icon icon="io:close"></iron-icon>
      </span>
    </div>

    <div relative on-session-bookmark="_onToggleSaveSession">

      <!-- <io-session-details id="sessionDetails" class="inline"
                          selected-session="{{selectedSession}}"
                          app="[[app]]"></io-session-details> -->
      <io-session-details id="sessionDetails"
                          selected-session="{{selectedSession}}"
                          app="[[app]]"
                          on-apply-filter="_useFilter"></io-session-details>

      <template is="dom-if" if="{{_dayIs(day, 'myschedule')}}">

        <div class="card bg-cyan-200">
          <div class="card-content card-content--myscheduleinfo"
               hidden$="[[!app.showMySchedulHelp]]">
            <iron-pages selected="[[_computeMyScheduleHelp(app.currentUser)]]">
              <div id="signin-prompt">
                <h3 class="card__title">Create your custom schedule</h3>
                <div>Sign in to add events to My Schedule.
                  <span class="notification__feature">
                    To get notifications on this device, you need to sign in and enable notifications.
                    <p class="note">Note: Notifications are activated per device. To receive notifications on multiple devices, sign in on each device, enable notifications, and make sure you're online. All device notifications can be turned on/off at any time in the settings panel.</p>
                  </span>
                </div>
                <paper-button class="cta-button" data-track-link="schedule-sign-in"
                              on-click="signIn">Sign in</paper-button>
              </div>
              <div id="notificationInfo" class="notification__feature">
                <paper-icon-button icon="io:close" aria-label="Close"
                               on-tap="closeHelp"></paper-icon-button>
                <div>If you have notifications enabled, you'll be notified on this device when:
                  <ul>
                    <li>Events in My Schedule are about to start</li>
                    <li>Videos of sessions added to My Schedule are available</li>
                  </ul>
                </div>
                <p class="note">
                  Note: Notifications are activated per device. To receive notifications on multiple devices, sign in on each device, enable notifications, and make sure you're online. All device notifications can be turned on/off at any time in the settings panel.
                </p>
                <span class="anchor-like" role="link" tabindex="0"
                      data-track-link="schedule-open-settings"
                      on-click="openSettings">Settings</span>
              </div>
            </iron-pages>
          </div>
        </div>

        <div class="card__container">

          <div class="card" on-session-bookmark="_onSessionRemove">

            <div class="myschedule-day-header card-content card-content--no-padding-right">
              <div>Wednesday</div>
              <h1>May 18</h1>
            </div>
            <div class="card-content card-content--no-padding-top card-content--no-padding-right" layout vertical>
              <template is="dom-repeat" items="[[sessions]]" as="session"
                        observe="saved" filter="[[_filterMyScheduleByDay(0)]]"
                        initial-count="10">
                <io-schedule-row session="[[session]]"></io-schedule-row>
              </template>
            </div>
            <div class="card-content card-content--day-footer card-content--no-padding-right" layout horizontal center-center>
              <span>Add more events.</span>
              <a href="#day1" data-subpage-link>Browse events</a>
            </div>

            <div class="myschedule-day-header card-content card-content--no-padding-right">
              <div>Thursday</div>
              <h1>May 19</h1>
            </div>
            <div class="card-content card-content--no-padding-top card-content--no-padding-right" layout vertical>
              <template is="dom-repeat" items="[[sessions]]" as="session"
                        observe="saved" filter="[[_filterMyScheduleByDay(1)]]"
                        initial-count="10">
                <io-schedule-row session="[[session]]"></io-schedule-row>
              </template>
            </div>
            <div class="card-content card-content--day-footer card-content--no-padding-right" layout horizontal center-center>
              <span>Add more events.</span>
              <a href="#day2" data-subpage-link>Browse events</a>
            </div>

            <div class="myschedule-day-header card-content card-content--no-padding-right">
              <div>Friday</div>
              <h1>May 20</h1>
            </div>
            <div class="card-content card-content--no-padding-top card-content--no-padding-right" layout vertical>
              <template is="dom-repeat" items="[[sessions]]" as="session"
                        observe="saved" filter="[[_filterMyScheduleByDay(2)]]"
                        initial-count="10">
                <io-schedule-row session="[[session]]"></io-schedule-row>
              </template>
            </div>
            <div class="card-content card-content--day-footer card-content--no-padding-right" layout horizontal center-center>
              <span>Add more events.</span>
              <a href="#day3" data-subpage-link>Browse events</a>
            </div>

          </div> <!-- .card -->
        </div> <!-- .card__container -->

      </template>

      <template is="dom-if" if="{{!_dayIs(day, 'myschedule')}}">

        <div class="card__container">

          <div class="card">

            <div class="card-content card-content--main card-content--no-padding-top card-content--no-padding-right" layout vertical>

              <template id="schedulelist" is="dom-repeat" items="[[sessions]]"
                        as="session" filter="matchesFilters" initial-count="10">
                <io-schedule-row session="[[session]]"
                    hidden$="[[!_showSession(session, day)]]"></io-schedule-row>
              </template>

            </div> <!-- .card-content -->

          </div> <!-- .card -->

        </div> <!-- .card__container -->

      </template>

    </div>

  </template>
  <script>
    (function () {
      Polymer({
        is: 'io-schedule',

        behaviors: [IOBehaviors.UtilBehavior],

        properties: {
          /**
           * Optional day to filter the sessions, e.g. 'day1'.
           */
          day: {
            type: String
          },

          /**
           * Array of applied filters.
           */
          filters: {
            type: Array,
            value: function() { return []; },
            notify: true
          },

          /**
           * Timestamp for the start of the event in GMT timezone.
           */
          gmtDayOne: {
            type: String
          },

          /**
           * Array of session theme names.
           */
          sessionThemes: {
            type: Array,
            value: function() { return []; }
          },

          /**
           * Array of session topic names.
           */
          sessionTopics: {
            type: Array,
            value: function() { return []; }
          },

          /**
           * Array of session types.
           */
          sessionTypes: {
            type: Array,
            value: function() { return []; }
          },

          /**
           * Array of scheduled sessions.
           */
          sessions: {
            type: Array,
            value: function() { return []; }
          },

          /**
           * User's list of saved sessions.
           */
          savedSessions: {
            type: Array,
            value: function() { return []; }
          },

          /**
           * True to show the filter panel
           */
          showFilters: {
            type: Boolean,
            value: false,
            notify: true
          },

          /**
           * Selected session to show details for.
           */
          selectedSession: {
            type: Object,
            value: null
          }
        },

        listeners: {
          'session-select': 'openSession'
        },

        observers: [
          '_filtersChanged(filters.length)',
          // Recalc time blocks when users list of saved sessions comes in.
          '_recalcFirstOfBlock(sessions.length, savedSessions.length)',
          // Recalc time blocks when new day is selected or filter is applied.
          '_recalcFirstOfBlock(sessions.length, day, filters.length)',
          '_savedSessionsChanged(savedSessions.splices)'
        ],

        attached: function() {
          this.listen(window, 'popstate', 'sessionDetailsPopstateHandler');
        },

        detached: function() {
          this.unlisten(window, 'popstate', 'sessionDetailsPopstateHandler');
        },

        isFilterSelected: function(filterName) {
          return this.filters.indexOf(filterName) > -1;
        },

        onApplyFilter: function(e, detail) {
          var radioGroup = Polymer.dom(e.target).node;

          // Remove previous selected filter.
          if (detail.item) {
            var deselected = detail.item.name;
            var idx = this.filters.indexOf(deselected);
            if (idx !== -1) {
              this.splice('filters', idx, 1);
            }
          } else if (radioGroup.selected) {
            this.push('filters', radioGroup.selected);
          }

          IOWA.Elements.Template.initFabScroll();
        },

        _useFilter: function(e, detail) {
          e.preventDefault();
          e.stopPropagation();
          this.clearFilters(e);
          this.filters = [detail.tag];
          this.selectedSession = null;
        },

        onLiveSessionsFilters: function(e) {
          var checkbox = Polymer.dom(e).localTarget;
          var idx = this.filters.indexOf(checkbox.name);
          if (idx !== -1) {
            this.splice('filters', idx, 1);
          } else if (checkbox.checked) {
            this.push('filters', checkbox.name);
          }
        },

        /**
         * Extracts filters from a URL deep link and updates the UI accordingly.
         */
        deepLinkFromURL: function() {
          // Note: global methods being used.
          var parsedUrl = IOWA.Router.parseUrl(window.location.toString());
          this.filters = this.getFiltersFromURL(parsedUrl);
          this._updateFilterRadioButtons();

          IOWA.Schedule.schedulePromise().then(function(data) {
            // Deep link into session. First, try to pull session id from the
            // ?sid= param. If that isn't present, use the parsed id from the fragment.
            var sessionId = IOWA.Util.getURLParameter('sid') || parsedUrl.resourceId;
            if (sessionId) {
              pageIsDeepLinked_ = true;
              this.openSession(IOWA.Schedule.getSessionById(sessionId));
            } else {
              pageIsDeepLinked_ = false;
            }
          }.bind(this));
        },

        _updateFilterRadioButtons: function() {
          if (!this.filters.length) {
            return;
          }

          var radios = this.$.filters.querySelectorAll('paper-radio-group');
          Array.prototype.forEach.call(radios, function(radio) {
            for (var i = 0, filter; filter = this.filters[i]; ++i) {
              radio.selected = filter;
              if (radio.selectedItem) {
                break;
              }
            }
          }.bind(this));

          var checkbox = this.$.liveStreamFilter;
          checkbox.checked = this.filters.indexOf(checkbox.name) > -1;
        },

        _filtersChanged: function(length) {
          // Don't modify URL or list of sessions if this is page load.
          if (!this._readied) {
            return;
          }

          var filters = this.filters.join(',');
          var search = window.location.search;
          if (filters.length) {
            search = IOWA.Util.setSearchParam(search, 'filters', filters);
          } else {
            search = IOWA.Util.removeSearchParam(search, 'filters');
          }

          // Force template repeat to re-render schedule list.
          var list = Polymer.dom(this.root).querySelector('#schedulelist');
          if (list) {
            list.render();
          }

          history.replaceState({}, '', [
            window.location.origin,
            window.location.pathname,
            search,
            window.location.hash
          ].join(''));
        },

        clearFilters: function(e) {
          e.preventDefault();
          e.stopPropagation();
          this.filters = [];

          var radios = this.$.filters.querySelectorAll('paper-radio-group');
          Array.prototype.forEach.call(radios, function(radio) {
            radio.selected = null;
          });

          this.$.liveStreamFilter.checked = false;
        },

        _showSession: function(session, day) {
          if (!day) {
            return false;
          }

          var showSession = false;

          if (day === 'myschedule' && session.saved) {
            showSession = true;
          }

          if (day !== 'myschedule') {
            var dayAsNumber = parseInt(day.split('day')[1]); // 'day1' => 1
            var ioStartDay = new Date(this.gmtDayOne).getDate(); // 18
            var dateIndex = (session.day % ioStartDay); // May 18 === 0

            if (!isNaN(dayAsNumber) && (dateIndex + 1) === dayAsNumber) {
              showSession = true;
            }
          }

          return showSession && this.matchesFilters(session);
        },

        matchesFilters: function(session) {
          if (!this.filters.length) {
            return true;
          }

          for (var i = 0, filter; filter = this.filters[i]; ++i) {
            if (!session.filters[filter]) {
              return false;
            }
          }
          return true;
        },

        signIn: function(e) {
          e.stopPropagation();
          // TODO: note global pollution. Consider firing bubbling event.
          IOWA.Elements.Template.signIn(e);
        },

        openSettings: function(e) {
          e.stopPropagation();
          // TODO: note global pollution. Consider firing bubbling event.
          IOWA.Elements.Template.openSettings(e);
        },

        _filterMyScheduleByDay: function(dayIdx) {
          return function(session) {
            return session.saved &&
                   session.day === this._dayIndexToDate(dayIdx);
          }.bind(this);
        },

        _dayIs: function(day, targetDay) {
          return day === targetDay;
        },

        _dayIndexToDate: function(timeBlockIdx) {
          var ioStartDay = new Date(this.gmtDayOne).getDate(); // 18
          return timeBlockIdx + ioStartDay;
        },

        _computeMyScheduleHelp: function(user) {
          return user ? 1 : 0;
        },

        _prettifyFilters: function(filters) {
          return this.filters.join(', ');
        },

        closeHelp: function() {
          this.set('app.showMySchedulHelp', false);
        },

        _recalcFirstOfBlock: function() {
          if (!this.sessions.length) {
            return;
          }

          this.debounce('_recalcFirstOfBlock', function() {
            var currentBlock;
            for (var i = 0, session; session = this.sessions[i]; ++i) {
              this.set(['sessions', i, 'firstOfBlock'], false);

              if (session.block !== currentBlock &&
                  this._showSession(session, this.day)) {
                this.set(['sessions', i, 'firstOfBlock'], true);
                currentBlock = session.block;
              }
            }
          }, 50);
        },

        _onSessionRemove: function(e, detail) {
          // Recalc time blocks when session is removed from my schedule.
          if (this.day === 'myschedule' && !detail.saved) {
            this._recalcFirstOfBlock();
          }
        },

        _onToggleSaveSession: function(e, detail) {
          e.stopPropagation();
          var saved = detail.saved;
          IOWA.Schedule.saveSession(detail.session.id, saved).then(function() {
            this.set('selectedSession.saved', saved);
            IOWA.Schedule.bookmarkSessionNotification(saved);
          }.bind(this));
        },

        sessionDetailsPopstateHandler: function(e) {
          // Pull session id from the ?sid= param. If that isn't present,
          // use the parsed id from the fragment.
          var url = IOWA.Router.parseUrl(window.location.toString());
          var sessionId = IOWA.Util.getURLParameter('sid') || url.resourceId;
          this.openSession(IOWA.Schedule.getSessionById(sessionId));
        },

        openSession: function(sessionOrEvent) {
          if (sessionOrEvent && sessionOrEvent.detail) {
            this.selectedSession = sessionOrEvent.detail.session;
          } else {
            this.selectedSession = sessionOrEvent;
          }
        },

        _savedSessionsChanged: function(record) {
          if (!this.savedSessions.length || !this.selectedSession) {
            return;
          }

          this.debounce('_savedSessionsChanged', function() {
            this.set('selectedSession.saved',
                     IOWA.Schedule.getSessionById(this.selectedSession.id).saved);
          }, 100);
        }

      });
    }());
  </script>
</dom-module>
