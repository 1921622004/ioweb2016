<!--
Copyright 2016 Google Inc. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at
  http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">

<link rel="import" href="../bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="../bower_components/paper-radio-button/paper-radio-button.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">

<link rel="import" href="shared-app-styles.html">


<dom-module id="io-schedule-row">
<link rel="import" type="css" href="io-schedule.css">
<template>
  <style include="shared-app-styles">
    :host {
      display: block;
    }
  </style>
  <div layout horizontal
       class$="[[_addClass('session-block', session.firstOfBlock)]]">
    <div class="schedule-block-title">
      <h1 layout horizontal end>
        <span>[[_getMeridiemPart(session.block, 0)]]</span>
        <span class="schedule-block-meridiem">[[_getMeridiemLetter(session.block)]]</span>
      </h1>
    </div>

    <div class$="schedule-row [[_addClass('saved', session.saved)]]"
         layout horizontal center
         on-keyup="onSessionKeyUp">
      <a href$="schedule?sid={{session.id}}"
         id="session-{{session.id}}-time"
         class="schedule-title"
         on-click="onSessionSelect"
         title$="{{session.title}}" flex>
        <div>[[session.title]]</div>
        <div id="session-{{session.id}}-time" class="schedule-time">
          <span>[[session.start]]</span>
          <span hidden$="{{_sessionIs(session, '__keynote__')}}"> - [[session.end]]</span> /
          <span>[[session.room]]</span>
          <iron-icon icon="io:videocam" class="schedule-livestream"
                     hidden$="{{!session.isLivestream}}"></iron-icon>
        </div>
      </a>

      <div class="schedule-toggle-buttons">
        <iron-icon icon="io:add-circle"
                   class="schedule-add-button"
                   on-click="onAddSession"></iron-icon>
        <iron-icon icon="io:remove-circle"
                   class="schedule-remove-button"
                   on-click="onRemoveSession"></iron-icon>
      </div>

    </div>

  </div>
</template>
<script>
(function() {
  Polymer({
    is: 'io-schedule-row',

    properties: {
      /**
       * IO session object.
       */
      session: {
        type: Object,
        value: function() { return {}; }
      }
    },

    onAddSession: function(e) {
      e.stopPropagation();
      this.fire('session-bookmark', {
        session: this.session,
        saved: true
      });
    },

    onRemoveSession: function(e) {
      e.stopPropagation();
      this.fire('session-bookmark', {
        session: this.session,
        saved: false
      });
    },

    // Useful for conditionally adding a class to an element based on prop.
    _addClass: function(name, prop) {
      return prop ? name : '';
    },

     _sessionIs: function(session, targetSession) {
      return session.id === targetSession;
    },

    _getMeridiemPart: function(str, part) {
      return str.split(' ')[part];
    },

    _getMeridiemLetter: function(sessionBlock) {
      return this._getMeridiemPart(sessionBlock, 1)[0];
    }

  });
}());
</script>
</dom-module>

<!--
The `<io-schedule>` element renders a schedule for a given day(s).
-->
<!--
Fired when session is selected.

@event session-select
@param {Object} detail
@param {Object} detail.session The selected session.
-->
<!--
Fired when the user toggles bookmarking/removing a session.

@event session-bookmark
@param {Object} detail
@param {Object} detail.session The session.
@param {Object} detail.save True if the session is being saved.
-->
<dom-module id="io-schedule">
  <link rel="import" type="css" href="io-schedule.css">
  <template>
    <style include="shared-app-styles">
      :host {
        display: block;
      }
    </style>

    <div hidden$="[[!showFilters]]">
      <div id="filters" class="card-content bg-bluegrey-50-40" layout horizontal justified>
        <div class="filter-section">
          <h4>Tracks</h4>
          <paper-radio-group allow-empty-selection
                             on-paper-radio-group-changed="onApplyFilter"
                             on-iron-deselect="onApplyFilter">
            <template is="dom-repeat" items="[[sessionThemes]]" as="theme">
              <paper-radio-button name="[[theme]]">[[theme]]</paper-radio-button>
            </template>
          </paper-radio-group>
        </div>
        <div class="filter-section">
          <h4>Types</h4>
          <paper-checkbox id="liveStreamFilter" name="Live streamed"
              on-tap="onLiveSessionsFilters">Live streamed</paper-checkbox>
          <paper-radio-group allow-empty-selection
                             on-paper-radio-group-changed="onApplyFilter"
                             on-iron-deselect="onApplyFilter">
            <template is="dom-repeat" items="[[sessionTypes]]" as="type">
              <paper-radio-button name="[[type]]">[[type]]</paper-radio-button>
            </template>
          </paper-radio-group>
        </div>
        <div class="filter-section filter-section--types" relative>
          <h4>Tracks</h4>
          <a href="#" class="filter-section--clearall" on-tap="clearFilters">Clear all</a>
          <paper-radio-group allow-empty-selection
                             on-paper-radio-group-changed="onApplyFilter"
                             on-iron-deselect="onApplyFilter">
            <template is="dom-repeat" items="[[sessionTopics]]" as="track">
              <paper-radio-button name="[[track]]">[[track]]</paper-radio-button>
            </template>
          </paper-radio-group>
        </div>
      </div>
    </div>


    <template is="dom-if" if="{{_dayIs(day, 'myschedule')}}">

      <div class="card bg-cyan-200">
        <div class="card-content">
          <span class="no-sessions">Add more events</span>
          <a href="#day1" data-subpage-link>Browse events</a>
        </div>
      </div>

      <div class="card__container">

        <div class="card">

          <div class="myschedule-day-header card-content">
            <div>Wednesday</div>
            <h1>May 18</h1>
          </div>
          <div class="card-content card-content--no-padding-top" layout vertical>
            <template is="dom-repeat" items="[[sessions]]" as="session"
                      observe="saved" filter="[[_filterMyScheduleByDay(0)]]"
                      initial-count="10">
              <io-schedule-row session="[[session]]"></io-schedule-row>
            </template>
          </div>

          <div class="myschedule-day-header card-content">
            <div>Thursday</div>
            <h1>May 19</h1>
          </div>
          <div class="card-content card-content--no-padding-top" layout vertical>
            <template is="dom-repeat" items="[[sessions]]" as="session"
                      observe="saved" filter="[[_filterMyScheduleByDay(1)]]"
                      initial-count="10">
              <io-schedule-row session="[[session]]"></io-schedule-row>
            </template>
          </div>

          <div class="myschedule-day-header card-content">
            <div>Friday</div>
            <h1>May 20</h1>
          </div>
          <div class="card-content card-content--no-padding-top" layout vertical>
            <template is="dom-repeat" items="[[sessions]]" as="session"
                      observe="saved" filter="[[_filterMyScheduleByDay(2)]]"
                      initial-count="10">
              <io-schedule-row session="[[session]]"></io-schedule-row>
            </template>
          </div>

        </div> <!-- .card -->
      </div> <!-- .card__container -->

    </template>

    <template is="dom-if" if="{{!_dayIs(day, 'myschedule')}}">

      <div class="card__container">

        <div class="card">

          <div class="card-content" layout vertical>

            <template id="schedulelist" is="dom-repeat" items="[[sessions]]"
                      as="session" filter="matchesFilters" initial-count="10">
               <io-schedule-row session="[[session]]" hidden$="{{!_showSession(session, day)}}"></io-schedule-row>
            </template>

          </div> <!-- .card-content -->

        </div> <!-- .card -->

      </div> <!-- .card__container -->

    </template>

  </template>
  <script>
    (function () {
      Polymer({
        is: 'io-schedule',

        properties: {
          /**
           * Optional day to filter the sessions, e.g. 'day1'.
           */
          day: {
            type: String
          },

          /**
           * Array of applied filters.
           */
          filters: {
            type: Array,
            value: function() { return []; },
            notify: true
          },

          /**
           * Timestamp for the start of the event in GMT timezone.
           */
          gmtDayOne: {
            type: String
          },

          /**
           * Array of session theme names.
           */
          sessionThemes: {
            type: Array,
            value: function() { return []; }
          },

          /**
           * Array of session topic names.
           */
          sessionTopics: {
            type: Array,
            value: function() { return []; }
          },

          /**
           * Array of session types.
           */
          sessionTypes: {
            type: Array,
            value: function() { return []; }
          },

          /**
           * Array of scheduled sessions.
           */
          sessions: {
            type: Array,
            value: function() { return []; }
          },

          /**
           * User's list of saved sessions.
           */
          savedSessions: {
            type: Array,
            value: function() { return []; }
          },

          /**
           * Array of my my session timeblocks
           */
          _timeBlocks: {
            type: Array,
            value: function() { return []; }
          },

          /**
           * True to show the filter panel
           */
          showFilters: {
            type: Boolean,
            value: false
          }
        },

        observers: [
          '_filtersChanged(filters.length)',
          '_updateMyScheduleTimeBlocks(sessions, savedSessions, gmtDayOne)'
        ],

        // Useful for conditionally adding a class to an element based on prop.
        _addClass: function(name, prop) {
          return prop ? name : '';
        },

        isFilterSelected: function(filterName) {
          return this.filters.indexOf(filterName) > -1;
        },

        onApplyFilter: function(e, detail) {
          var radioGroup = Polymer.dom(e.target).node;

          // Remove previous selected filter.
          if (detail.item) {
            var deselected = detail.item.name;
            var idx = this.filters.indexOf(deselected);
            if (idx !== -1) {
              this.splice('filters', idx, 1);
            }
          } else if (radioGroup.selected) {
            this.push('filters', radioGroup.selected);
          }
        },

        onLiveSessionsFilters: function(e) {
          var checkbox = Polymer.dom(e).localTarget;
          var idx = this.filters.indexOf(checkbox.name);
          if (idx !== -1) {
            this.splice('filters', idx, 1);
          } else if (checkbox.checked) {
            this.push('filters', checkbox.name);
          }
        },

        _deepLinkRadioButtons: function() {
          if (!this.filters.length) {
            return;
          }

          var radios = this.$.filters.querySelectorAll('paper-radio-group');
          Array.prototype.forEach.call(radios, function(radio) {
            for (var i = 0, filter; filter = this.filters[i]; ++i) {
              radio.selected = filter;
              if (radio.selectedItem) {
                break;
              }
            }
          }.bind(this));

          var checkbox = this.$.liveStreamFilter;
          checkbox.checked = this.filters.indexOf(checkbox.name) > -1;
        },

        _filtersChanged: function(length) {
          // Don't modify URL or list of sessions if this is page load.
          if (!this._readied) {
            return;
          }

          var filters = this.filters.join(',');
          var search = window.location.search;
          if (filters.length) {
            search = IOWA.Util.setSearchParam(search, 'filters', filters);
          } else {
            search = IOWA.Util.removeSearchParam(search, 'filters');
          }

          // Force template repeat to re-render schedule list.
          var list = Polymer.dom(this.root).querySelector('#schedulelist');
          if (list) {
            list.render();
          }

          history.replaceState({}, '', [
            window.location.origin,
            window.location.pathname,
            search,
            window.location.hash
          ].join(''));
        },

        clearFilters: function(e) {
          e.preventDefault();
          e.stopPropagation();
          this.filters = [];

          var radios = this.$.filters.querySelectorAll('paper-radio-group');
          Array.prototype.forEach.call(radios, function(radio) {
            radio.selected = null;
          });

          this.$.liveStreamFilter.checked = false;
        },

        _showSession: function(session, day) {
          var showSession = false;

          if (day === 'myschedule' && session.saved) {
            showSession = true;
          }

          if (day !== 'myschedule') {
            var dayAsNumber = parseInt(day.split('day')[1]); // 'day1' => 1
            var ioStartDay = new Date(this.gmtDayOne).getDate(); // 18
            var dateIndex = (session.day % ioStartDay); // May 18 === 0

            if (!isNaN(dayAsNumber) && (dateIndex + 1) === dayAsNumber) {
              showSession = true;
            }
          }

          return showSession && this.matchesFilters(session);
        },

        matchesFilters: function(session) {
          if (!this.filters.length) {
            return true;
          }
          for (var i = 0, filter; filter = this.filters[i]; ++i) {
            if (!session.filters[filter]) {
              return false;
            }
          }
          return true;
        },

        _updateMyScheduleTimeBlocks: function(sessions, savedSessions, gmtDayOne) {
          if (!sessions.length || !savedSessions.length) {
            return;
          }

          var timeBlocks = [[], [], []];

          var ioStartDay = new Date(this.gmtDayOne).getDate(); // 18

          for (var i = 0, s; s = this.sessions[i]; ++i) {
            var dayIndex = (s.day % ioStartDay); // May 18 === 0
            if (s.saved) {
              timeBlocks[dayIndex].push(s);
            }
          }

          this._timeBlocks = timeBlocks;
        },

        _filterMyScheduleByDay: function(dayIdx) {
          return function(session) {
            return session.saved &&
                   session.day === this._dayIndexToDate(dayIdx);
          }.bind(this)
        },

        onSessionSelect: function(e, detail) {
          e.preventDefault();
          e.stopPropagation();
          this.selectSession(e.model.session);
        },

        onSessionKeyUp: function(e, detail) {
          // enter or ctrl+alt+space (voice over click)
          if (e.keyCode === 13 || e.altKey && e.ctrlKey && e.keyCode === 32) {
            this.selectSession(e.model.session);
          }
        },

        selectSession: function(session) {
          this.fire('session-select', {session: session});
        },

        _dayIs: function(day, targetDay) {
          return day === targetDay;
        },

        _dayIndexToDate: function(timeBlockIdx) {
          var ioStartDay = new Date(this.gmtDayOne).getDate(); // 18
          return timeBlockIdx + ioStartDay;
        }

      });
    }());
  </script>
</dom-module>
